(this.webpackJsonprpnlatex=this.webpackJsonprpnlatex||[]).push([[0],{15:function(e,t,s){},16:function(e,t,s){},22:function(e,t,s){"use strict";s.r(t);var r=s(0),i=s.n(r),n=s(6),a=s.n(n),o=(s(15),s(16),s(3)),p=s.n(o);var _={base:{"[alnum]":"self_push","#":"push \\#","@":"push @","*":"push *","~":"push \\sim","!":"autoparenthesize;push !;concat",Enter:"subscript","Shift+Enter":"edit_item","^":"superscript",Backspace:"pop","`":"superscript"," ":"autoparenthesize 2;concat","=":"mode relational","<":"infix <",">":"infix >","+":"infix +","-":"infix -","]":"make_bold","[":"delimiters [ ]","(":"delimiters ( )","{":"delimiters \\{ \\}",ArrowUp:"change_document_selection -1","Shift+ArrowUp":"shift_document_selection -1",ArrowDown:"change_document_selection +1","Shift+ArrowDown":"shift_document_selection +1",PageUp:"change_document_selection -5",PageDown:"change_document_selection +5",Home:"change_document_selection -10000",End:"change_document_selection +10000",ArrowRight:"scroll stack_panel horizontal 75",ArrowLeft:"scroll stack_panel horizontal -75",Tab:"mode stack","'":"mode symbol",".":"mode decoration",",":"mode infix",")":"mode delimiters","}":"custom_delimiter",";":"mode lowercase_greek",":":"mode uppercase_greek","%":"mode calligraphic","&":"mode script","/":"mode operator","\\":"start_text_entry math_text_entry",'"':"start_text_entry text_entry","|":"mode array",_:"start_dissect_mode",$:"mode config","?":"toggle_popup help","Ctrl+0":"push 0;subscript","Ctrl+1":"push -1;superscript","Ctrl+2":"push 2;superscript","Ctrl+3":"push 3;superscript","Ctrl+4":"push 4;superscript","Ctrl+a":"swap","Ctrl+b":"make_bold","Ctrl+c":"copy_to_clipboard","Ctrl+e":"push e;operator mathrm;swap;superscript","Ctrl+i":"pop_to_document","Ctrl+j":"extract_from_document","Ctrl+k":"infix \\,","Ctrl+l":"recenter_document 50","Ctrl+m":"push -;swap;fuse","Ctrl+o":"parenthesize;fuse","Ctrl+p":"delimiters ( )","Ctrl+r":"infix ,;parenthesize;fuse","Ctrl+s":"save_file","Ctrl+u":"superscript","Ctrl+v":"paste_from_clipboard","Ctrl+y":"redo","Ctrl+z":"undo","Ctrl+ ":"infix \\,","Ctrl+,":"infix ,","Ctrl+ArrowRight":"scroll document_container horizontal 75","Ctrl+ArrowLeft":"scroll document_container horizontal -75","Ctrl+/":"operator frac 2"},files:{default:"toggle_popup files",d:"delete_selected_file",n:"start_new_file",Enter:"load_selected_file",s:"save_file",S:"save_file_as",ArrowUp:"select_adjacent_file -1",ArrowDown:"select_adjacent_file 1",j:"scroll popup_panel vertical 25",k:"scroll popup_panel vertical -25"},help:{ArrowDown:"scroll popup_panel vertical 25",ArrowUp:"scroll popup_panel vertical -25",j:"scroll popup_panel vertical 25",k:"scroll popup_panel vertical -25",ArrowLeft:"cancel",ArrowRight:"cancel",PageUp:"scroll popup_panel vertical -95",PageDown:"scroll popup_panel vertical 95",default:"toggle_popup help"},stack:{"[digit]":"prefix_argument","*":"prefix_argument",a:"swap",c:"copy_to_clipboard",d:"pop",i:"pop_to_document",I:"pop_to_document preserve",f:"toggle_popup files",j:"extract_from_document",J:"extract_from_document preserve",l:"recenter_document 50",n:"nip",o:"over",r:"rot",s:"save_file",t:"tuck",u:"unrot",v:"paste_from_clipboard",X:"reset_all",Enter:"dup",Backspace:"pop",Tab:"undo",".":"redo","!":"export_document_as_text","@":"export_stack_items_as_text",$:"extract_latex_source",ArrowRight:"scroll document_container horizontal 75",ArrowLeft:"scroll document_container horizontal -75"},config:{"[digit]":"prefix_argument","*":"prefix_argument",ArrowLeft:"config stack_side left",ArrowRight:"config stack_side right",ArrowUp:"config stack_side top",ArrowDown:"config stack_side bottom",f:"fullscreen on",F:"fullscreen off",i:"config toggle_inline_math",I:"config toggle_mode_indicator",m:"config math_align toggle_document",M:"config math_align toggle_stack",r:"config reset_layout",R:"config reload_page",s:"config stack_split",v:"config inverse_video",z:"config zoom_factor increase",Z:"config zoom_factor decrease",$:"push \\$","!":"push \\alpha\\boldsymbol{\\alpha}\\mathcal{A}\\mathfrak{A}A\\bold{A}\\boldsymbol{A}\\mathtt{A}\\mathrm{A}\\mathsf{A}\\textup{A}\\Bbb{A}\\mathscr{A}[\\big[\\Big[\\bigg[\\Bigg[\\int"},text_entry:{Enter:"finish_text_entry text","Shift+Enter":"finish_text_entry heading",Escape:"cancel_text_entry","Ctrl+z":"cancel_text_entry",Backspace:"backspace_text_entry",ArrowLeft:"text_entry_move_cursor left",ArrowRight:"text_entry_move_cursor right",default:"append_text_entry"},math_text_entry:{Enter:"finish_text_entry math","Shift+Enter":"finish_text_entry roman_math","\\":"start_text_entry latex_entry",Escape:"cancel_text_entry","Ctrl+z":"cancel_text_entry",Backspace:"backspace_text_entry",ArrowLeft:"text_entry_move_cursor left",ArrowRight:"text_entry_move_cursor right",default:"append_text_entry"},latex_entry:{Enter:"finish_text_entry latex",Escape:"cancel_text_entry","Ctrl+z":"cancel_text_entry",Backspace:"backspace_text_entry math_text_entry",ArrowLeft:"text_entry_move_cursor left",ArrowRight:"text_entry_move_cursor right",default:"append_text_entry"},delimiters:{b:"delimiters \\langle \\vert",c:"delimiters \\lceil \\rceil",f:"delimiters \\lfloor \\rfloor",F:"toggle_fixed_size_delimiters",g:"delimiters \\lgroup \\rgroup",i:"delimiters \\langle \\rangle \\vert 2",I:"delimiters \\langle \\rangle \\vert 3",k:"delimiters \\vert \\rangle",m:"delimiters \\lmoustache \\rmoustache",n:"delimiters \\lVert \\rVert",N:"delimiters \\lVert \\rVert",w:"delimiters . \\vert",W:"delimiters . \\vert",x:"remove_delimiters","|":"delimiters \\vert \\vert","<":"delimiters \\langle \\rangle","(":"delimiters ( )","[":"delimiters [ ]","]":"push \\llbracket;swap;concat;push \\rrbracket;concat","{":"delimiters \\{ \\}"},custom_delimiters:{"[digit]":"prefix_argument",c:"custom_delimiter \\lceil",C:"custom_delimiter \\rceil",f:"custom_delimiter \\lfloor",F:"custom_delimiter \\rfloor",g:"custom_delimiter \\lgroup",G:"custom_delimiter \\rgroup",m:"custom_delimiter \\lmoustache",M:"custom_delimiter \\rmoustache",v:"custom_delimiter \\Vert","<":"custom_delimiter \\langle",">":"custom_delimiter \\rangle","(":"custom_delimiter (",")":"custom_delimiter )","[":"custom_delimiter [","]":"custom_delimiter ]","{":"custom_delimiter \\{","}":"custom_delimiter \\}",".":"custom_delimiter ."," ":"custom_delimiter .","/":"custom_delimiter /","\\":"custom_delimiter \\backslash","|":"custom_delimiter |"},operator:{1:"push 1;swap;operator frac 2",2:"mode squared",a:"apply_operator 1",A:"apply_operator 2",b:"operator binom 2",c:"named_function cos",C:"named_function csc",d:"mode derivative",D:"named_function det",e:"push e;operator mathrm;swap;superscript",E:"named_function exp",f:"mode named_operator",h:"mode hyperbolic",i:"mode integral_limits",I:"push \\int;swap;superscript;swap;subscript",k:"delimiters . . \\vert 2;parenthesize;fuse",l:"push \\limits;swap;subscript;push \\lim;swap;concat",L:"infix \\to;push \\limits;swap;subscript;push \\lim;swap;concat",n:"named_function ln",N:"named_function log",o:"parenthesize;fuse",O:"swap;operator overset 2",p:"parenthesize;operator Pr",P:"push \\,;swap;concat;swap;push \\,;concat;swap;delimiters . . \\vert 2;parenthesize;operator Pr",q:"operator sqrt",Q:"operator sqrt[3]",r:"infix ,;parenthesize;fuse",s:"named_function sin",S:"named_function sec",t:"named_function tan",T:"named_function cot",U:"swap;operator underset 2",v:"parenthesize;push Var;operator operatorname;swap;concat",V:"swap;push ,;concat;swap;concat;parenthesize;push Cov;operator operatorname;swap;concat",w:"swap_infix",x:"push E;operator mathbb;swap;delimiters [ ];fuse",X:"push \\,;swap;concat;swap;push \\,;concat;swap;delimiters . . \\vert 2;delimiters [ ];push E;operator mathbb;swap;fuse",y:"push E;operator mathbb;swap;subscript;swap;delimiters [ ];fuse",Y:"unrot;push \\,;swap;concat;swap;push \\,;concat;swap;delimiters . . \\vert 2;delimiters [ ];swap;push E;operator mathbb;swap;subscript;swap;fuse",";":"apply_tag",",":"split_infix","/":"operator frac 2","[":"delimiters [ ];fuse","]":"delimiters \\{ \\};fuse","}":"swap;operator underbrace;swap;subscript","{":"swap;operator overbrace;swap;superscript","<":"extract_infix_side left",">":"extract_infix_side right","-":"mode inverse","=":"unrot;infix =;push \\sum;swap;subscript;swap;superscript","+":"infix \\ge;push \\sum;swap;subscript","'":"substitute_placeholder",'"':"toggle_is_heading",Enter:"unrot;subscript;swap;superscript"},named_operator:{a:"operator arg",c:"operator gcd",d:"operator dim",e:"operator deg",f:"operator liminf",g:"operator argmax",h:"operator hom",i:"operator inf",k:"operator ker",l:"operator lim",m:"operator min",n:"operator argmin",o:"push Cov;operator operatorname;swap;concat",p:"operator Pr",r:"push tr;operator operatorname;swap;concat",s:"operator sup",t:"operator det",u:"operator limsup",v:"push Var;operator operatorname;swap;concat",x:"operator max",A:"underset_operator arg",C:"underset_operator gcd",D:"underset_operator dim",E:"underset_operator deg",F:"underset_operator liminf",G:"underset_operator argmax",H:"underset_operator hom",I:"underset_operator inf",K:"underset_operator ker",L:"underset_operator lim",M:"underset_operator min",N:"underset_operator argmin",O:"underset_operator Cov true",P:"underset_operator Pr",R:"underset_operator tr true",S:"underset_operator sup",T:"underset_operator det",U:"underset_operator limsup",V:"underset_operator Var true",X:"underset_operator max"},hyperbolic:{s:"named_function sinh",S:"named_function sech",c:"named_function cosh",C:"named_function csch",t:"named_function tanh",T:"named_function coth",2:"mode squared_hyperbolic","-":"mode inverse_hyperbolic"},inverse:{s:"named_function sin -1",S:"named_function sec -1",c:"named_function cos -1",C:"named_function csc -1",t:"named_function tan -1",T:"named_function cot -1",h:"mode inverse_hyperbolic",2:"mode squared"},inverse_hyperbolic:{s:"named_function sinh -1",S:"named_function sech -1",c:"named_function cosh -1",C:"named_function csch -1",t:"named_function tanh -1",T:"named_function coth -1",2:"mode squared_hyperbolic"},squared:{s:"named_function sin 2",S:"named_function sec 2",c:"named_function cos 2",C:"named_function csc 2",t:"named_function tan 2",T:"named_function cot 2",n:"named_function lg",N:"named_function log _2",h:"mode squared_hyperbolic","-":"mode inverse"},squared_hyperbolic:{s:"named_function sinh 2",S:"named_function sech 2",c:"named_function cosh 2",C:"named_function csch 2",t:"named_function tanh 2",T:"named_function coth 2","-":"mode inverse_hyperbolic"},integral_limits:{r:"push -\\infty;subscript;push \\infty;superscript",n:"push -\\infty;subscript;push 0;superscript",p:"push 0;subscript;push \\infty;superscript",u:"push 0;subscript;push 1;superscript",U:"push -1;subscript;push 1;superscript",t:"push 0;subscript;push 2\\pi;superscript",T:"push -\\pi;subscript;push \\pi;superscript"},derivative:{j:"push \\partial;swap;concat;swap;push \\partial;swap;concat;swap;operator frac 2",J:"push 2;superscript;push \\partial;swap;concat;swap;push \\partial;push 2;superscript;swap;concat;swap;operator frac 2",k:"push d;operator mathrm;swap;concat;swap;push d;operator mathrm;swap;concat;swap;operator frac 2",K:"push 2;superscript;push d;operator mathrm;swap;concat;swap;push d;operator mathrm;push 2;superscript;swap;concat;swap;operator frac 2",q:"push \\partial;swap;concat;push \\partial;swap;operator frac 2",Q:"push 2;superscript;push \\partial;swap;concat;push \\partial;push 2;superscript;swap;operator frac 2",x:"push d;operator mathrm;swap;concat;push d;operator mathrm;swap;operator frac 2",X:"push 2;superscript;push d;operator mathrm;swap;concat;push d;operator mathrm;push 2;superscript;swap;operator frac 2",m:"push \\partial;swap;concat;push \\partial;rot;concat;swap;push \\,;swap;concat;concat;push \\partial;push 2;superscript;swap;operator frac 2",M:"push \\partial;swap;concat;push \\partial;rot;concat;swap;push \\,;swap;concat;concat;swap;push \\partial;push 2;superscript;swap;concat;swap;operator frac 2",g:"push \\nabla;swap;concat",G:"push \\nabla;swap;subscript;swap;concat",".":"push \\nabla;push \\cdot;concat;swap;concat",c:"push \\nabla;push \\times;concat;swap;concat",l:"push \\nabla;push 2;superscript;swap;concat",L:"push \\Box;push 2;superscript;swap;concat",d:"push d;operator mathrm;swap;fuse",2:"push d;operator mathrm;push 2;superscript;swap;fuse",3:"push d;operator mathrm;push 3;superscript;swap;fuse",4:"push d;operator mathrm;push 4;superscript;swap;fuse",i:"swap;push \\,;concat;swap;push d;operator mathrm;swap;fuse;concat",I:"push d;operator mathrm;swap;fuse;concat;push \\,;concat"," ":"push d;operator mathrm;swap;fuse;concat"},infix:{a:"apply_infix",b:"infix \\bullet",c:"infix \\cap",d:"infix \\setminus",e:"infix ,\\dots,",f:"conjunction if",F:"conjunction iff",g:"infix \\gets",k:"push \\,;swap;concat;swap;push \\,;concat;swap;delimiters . . \\vert 2",l:"infix \\parallel",M:"infix \\mp",n:"conjunction when",o:"infix \\circ",O:"infix \\odot",p:"infix \\perp",P:"infix \\pm",q:"conjunction and",Q:"conjunction or",r:"conjunction for",s:"infix \\,",t:"infix \\to",T:"infix \\longrightarrow",u:"infix \\cup",v:"infix \\vee",V:"infix \\veebar",w:"infix \\wedge",W:"infix \\barwedge",x:"infix \\times",X:"infix \\otimes","[":"infix \\llcorner","]":"infix \\lrcorner","|":"delimiters . . \\vert 2","=":"infix \\Rightarrow","-":"infix \\ominus","+":"infix \\oplus",".":"infix \\cdot",",":"infix ,"," ":"infix ,\\,",":":"infix :",";":"infix semicolon\\:","`":"swap;push T;superscript;swap;concat","%":"operator pmod;concat","*":"infix *","(":"infix ,;delimiters ( )","<":"infix ,;delimiters \\langle \\rangle",">":"infix \\cdots","/":"autoparenthesize 2;delimiters . . / 2","\\":"autoparenthesize 2;infix /"},relational:{9:"infix \\prec",0:"infix \\succ",a:"infix \\approx",c:"infix \\cong",e:"infix \\equiv",E:"infix \\iff",g:"infix >",f:"infix \\Leftarrow",G:"infix \\gg",i:"infix \\in",I:"infix \\notin",j:"infix \\Join",l:"infix <",L:"infix \\ll",m:"infix \\mapsto",n:"infix \\ne","!":"infix \\ne",o:"infix \\circeq",p:"infix \\propto",q:"infix =",s:"infix \\subseteq",S:"infix \\subset",t:"infix \\sim",u:"infix \\supseteq",U:"infix \\supset","=":"infix =","^":"infix \\triangleq","<":"infix \\le",">":"infix \\ge","[":"infix \\le","]":"infix \\ge","{":"infix \\sqsubset","}":"infix \\sqsupset","(":"infix \\preceq",")":"infix \\succeq",".":"infix \\doteq",":":"infix \\coloneqq",";":"infix \\coloncolon","~":"infix \\sim","-":"infix \\vdash","|":"infix \\vDash","?":"push ?;push =;operator overset 2;apply_infix"},symbol:{0:"push \\varnothing",1:"push -1",2:"push 1;push 2;operator frac 2",3:"push 1;push 2;infix /",8:"push \\infty",a:"push \\forall",c:"push \\cdot",C:"push \\bigcap",d:"push \\partial",e:"push \\exists",E:"push \\nexists",h:"push \\hslash",i:"push \\int",I:"push \\iint",l:"push \\ell",M:"push \\mp",n:"push \\ne",o:"push \\circ",p:"push \\prod",P:"push \\pm",s:"push \\sum",t:"push \\therefore",U:"push \\bigcup",v:"push \\vee",V:"push \\bigvee",w:"push \\wedge",W:"push \\bigwedge",y:"push \\oint",Y:"push \\oiint",".":"push \\dots",">":"push \\cdots","-":"push -","+":"push +","*":"push \\star","|":"push |","=":"push_separator","?":"push ?","!":"push !",",":"push ,",";":"push semicolon",":":"push :","`":"push `",_:"push \\_","'":"push_placeholder"," ":"push ",ArrowUp:"push \\uparrow",ArrowDown:"push \\downarrow"},decoration:{0:"push 0;subscript",1:"push -1;superscript",2:"push 2;superscript",3:"push 3;superscript",4:"push 4;superscript",8:"push \\infty;infix \\to",A:"operator acute",b:"font_operator mathbb",c:"autoparenthesize;push 1;swap;infix -",C:"html_class emphasized emphasized2",d:"push \\dagger;superscript",D:"push \\ddagger;superscript",e:"operator bold",g:"operator mathring",G:"operator grave",h:"apply_hat hat",H:"apply_hat widehat",i:"push -;superscript",I:"push +;superscript",k:"font_operator mathfrak",l:"push \\parallel;subscript",m:"font_operator mathtt",M:"push \\mp;swap;fuse",n:"push \\neg;swap;fuse",o:"operator bar",O:"operator overline",p:"push \\perp;subscript",P:"push \\pm;swap;fuse",q:"push =;swap;fuse",r:"make_roman",s:"font_operator mathsf",t:"push \\to;swap;fuse",T:"operator widetilde",u:"apply_hat breve",U:"operator utilde",v:"operator vec",V:"apply_hat check",w:"operator overline",W:"apply_hat widecheck",x:"operator boxed",X:"operator sout",z:"operator cancel",".":"apply_hat dot",">":"push .;concat",'"':"apply_hat ddot"," ":"push \\,;concat","'":"autoparenthesize;prime","*":"push *;superscript","~":"apply_hat tilde","=":"push \\Rightarrow;swap;fuse","-":"push -;swap;fuse","+":"push +;swap;fuse","`":"push T;superscript","/":"push 1;swap;autoparenthesize;delimiters . . / 2","\\":"push 1;swap;autoparenthesize;infix /",_:"operator underline"},array:{"[digit]":"prefix_argument","*":"prefix_argument",a:"build_align aligned",c:"build_align cases",C:"build_align rcases",d:"dissolve_array",e:"build_infix_list ,\\,;push \\dots;push ,\\,;apply_infix",E:"insert_matrix_ellipses",f:"build_align cases_if",F:"build_align rcases_if",g:"build_align gathered",h:"transpose_matrix;swap;transpose_matrix;swap;stack_arrays;transpose_matrix",k:"build_substack",m:"build_matrix_row matrix",p:"build_infix_list +;push \\cdots;push +;apply_infix",s:"split_array",t:"mode change_matrix_type",T:"transpose_matrix",v:"build_matrix_row vmatrix",V:"build_matrix_row Vmatrix","|":"stack_arrays",",":"build_infix_list ,\\,",".":"build_infix_list ,\\, \\dots",";":"build_infix_list semicolon\\,","+":"build_infix_list + \\cdots","(":"build_matrix_row pmatrix","[":"build_matrix_row bmatrix","{":"build_matrix_row Bmatrix","@":"build_matrix_row bmatrix 2;transpose_matrix","#":"build_matrix_row bmatrix 3;transpose_matrix",$:"build_matrix_row bmatrix 2;unrot;build_matrix_row bmatrix 2;swap;stack_arrays",":":"array_separator column dashed","!":"array_separator column solid","-":"array_separator row dashed",_:"array_separator row solid",Enter:"stack_arrays"},change_matrix_type:{m:"change_matrix_type matrix",v:"change_matrix_type vmatrix",V:"change_matrix_type Vmatrix","(":"change_matrix_type pmatrix","[":"change_matrix_type bmatrix","{":"change_matrix_type Bmatrix"},dissect:{default:"cancel_dissect_mode",Escape:"cancel_dissect_mode",q:"cancel_dissect_mode",Q:"cancel_dissect_mode",Tab:"dissect_undo","Ctrl+z":"dissect_undo",_:"dissect_descend",u:"dissect_ascend",U:"dissect_ascend",ArrowUp:"dissect_ascend",ArrowDown:"dissect_descend",ArrowLeft:"dissect_move_selection left",ArrowRight:"dissect_move_selection right","[":"dissect_move_selection left","{":"dissect_move_selection left","]":"dissect_move_selection right","}":"dissect_move_selection right",x:"dissect_extract_selection",X:"dissect_extract_selection",d:"dissect_extract_selection trim",D:"dissect_extract_selection trim",Backspace:"dissect_extract_selection trim","'":"dissect_extract_selection",c:"dissect_copy_selection",C:"dissect_copy_selection",t:"dissect_copy_selection trim",T:"dissect_copy_selection trim"},script:{"[alpha]":"self_push;to_case uppercase;font_operator mathscr","&":"push \\&"},calligraphic:{"[alpha]":"self_push;to_case uppercase;font_operator mathcal","%":"push \\%"},lowercase_greek:{a:"push \\alpha",b:"push \\beta",c:"push \\chi",d:"push \\delta",e:"push \\epsilon",f:"push \\phi",g:"push \\gamma",h:"push \\eta",i:"push \\iota",j:"push \\varphi",k:"push \\kappa",l:"push \\lambda",m:"push \\mu",n:"push \\nu",o:"push \\omega",p:"push \\pi",q:"push \\vartheta",r:"push \\rho",s:"push \\sigma",t:"push \\tau",u:"push \\upsilon",v:"push \\theta",w:"push \\omega",x:"push \\xi",y:"push \\psi",z:"push \\zeta",":":"mode variant_greek",";":"infix semicolon"},uppercase_greek:{d:"push \\Delta",e:"push \\varepsilon",f:"push \\Phi",g:"push \\Gamma",k:"push \\varkappa",l:"push \\Lambda",m:"push \\varpi",o:"push \\Omega",p:"push \\Pi",q:"push \\vartheta",r:"push \\varrho",s:"push \\Sigma",t:"push \\varsigma",u:"push \\Upsilon",v:"push \\Theta",w:"push \\Omega",x:"push \\Xi",y:"push \\Psi",6:"push \\digamma","^":"push \\digamma",n:"push \\nabla",D:"push \\Delta",E:"push \\varepsilon",F:"push \\Phi",G:"push \\Gamma",K:"push \\varkappa",L:"push \\Lambda",M:"push \\varpi",O:"push \\Omega",P:"push \\Pi",Q:"push \\vartheta",R:"push \\varrho",S:"push \\Sigma",T:"push \\varsigma",U:"push \\Upsilon",V:"push \\Theta",W:"push \\Omega",X:"push \\Xi",Y:"push \\Psi",N:"push \\nabla",":":"infix :"},variant_greek:{d:"push \\varDelta",D:"push \\varDelta",f:"push \\varPhi",F:"push \\varPhi",g:"push \\varGamma",G:"push \\varGamma",l:"push \\varLambda",L:"push \\varLambda",o:"push \\varOmega",O:"push \\varOmega",p:"push \\varPi",P:"push \\varPi",q:"push \\varTheta",Q:"push \\varTheta",s:"push \\varSigma",S:"push \\varSigma",u:"push \\varUpsilon",U:"push \\varUpsilon",x:"push \\varXi",X:"push \\varXi",y:"push \\varPsi",Y:"push \\varPsi"}},l=s(4),c=s.n(l);class h{constructor(){this.bindings=_}lookup_binding(e,t){const s=this.bindings[e];return s?s[t]?s[t]:s["[alpha]"]&&/^[a-zA-Z]$/.test(t)?s["[alpha]"]:s["[digit]"]&&/^[0-9]$/.test(t)?s["[digit]"]:s["[alnum]"]&&/^[a-zA-Z0-9]$/.test(t)?s["[alnum]"]:s.default?s.default:"base"===e||"editor"===e?null:"cancel":null}}class u{static load_from_local_storage(){const e=localStorage.getItem("settings");return e?u.from_json(JSON.parse(e)):new u}static from_json(e){let t=new u;return u.saved_keys.forEach((s=>{t[s]=e[s]})),t}constructor(){this.current_keymap=new h,this.inverse_video=!1,this.last_opened_filename=null,this.popup_mode=null,this.show_mode_indicator=!0,this.layout=this.default_layout()}default_layout(){return{zoom_factor:0,stack_rightalign_math:!1,document_rightalign_math:!1,inline_math:!1,stack_side:"left",stack_split:50}}apply_layout_to_dom(e,t,s){const r=this.layout;s.style.display=this.popup_mode?"block":"none";const i=document.getElementById("root"),n=Math.round(100*Math.pow(1.05,r.zoom_factor||0));i.style.fontSize=n+"%";const a=document.querySelector(":root"),o=Math.min(10,Math.max(2,Math.round(4*n/100)));a.style.setProperty("--itemtype-bar-width",o+"px");const p=Math.max(1,Math.round(3*n/100));a.style.setProperty("--heading-bar-height",p+"px");let[_,l]=this._split_rectangle({x:0,y:0,w:100,h:100},r.stack_side,r.stack_split);this._apply_bounds(e,_),this._apply_bounds(t,l)}_split_rectangle(e,t,s){const r=Math.round(s*e.w/100),i=e.w-r,n=Math.round(s*e.h/100),a=e.h-n;switch(t){case"left":return[{x:e.x,y:e.y,w:r,h:e.h},{x:e.x+r,y:e.y,w:i,h:e.h}];case"right":return[{x:e.x+i,y:e.y,w:r,h:e.h},{x:e.x,y:e.y,w:i,h:e.h}];case"top":return[{x:e.x,y:e.y,w:e.w,h:n},{x:e.x,y:e.y+n,w:e.w,h:a}];case"bottom":return[{x:e.x,y:e.y+a,w:e.w,h:n},{x:e.x,y:e.y,w:e.w,h:a}];default:return[e,e]}}_apply_bounds(e,t){e.style.left=t.x+"%",e.style.top=t.y+"%",e.style.width=t.w+"%",e.style.height=t.h+"%"}save(){const e=JSON.stringify(this.to_json());localStorage.setItem("settings",e)}to_json(){let e={};return u.saved_keys.forEach((t=>{e[t]=this[t]})),e}}u.saved_keys=["inverse_video","last_opened_filename","popup_mode","layout","show_mode_indicator"];class d{constructor(e,t){this.tokens=[],this.last_token_type=null,this.selected_expr_path=t,this.selected_expr_path&&(this.current_path=new b(e,[]))}emit_token(e,t){e.length>0&&this.tokens.push(e),this.last_token_type=t}expr(e,t){if(null!==t&&this.selected_expr_path&&(this.current_path=this.current_path.descend(t)),this.selected_expr_path&&this.selected_expr_path.equals(this.current_path)){new k("htmlClass",[new E("dissect_highlight_brace"),new k("overbrace",[new k("htmlClass",[new E("dissect_highlight"),e])])]).emit_latex(this)}else e.emit_latex(this);null!==t&&this.selected_expr_path&&(this.current_path=this.current_path.ascend())}grouped_expr(e,t,s){this.grouped((()=>this.expr(e,s)),t)}grouped(e,t){let[s,r]=[this.tokens,this.last_token_type];[this.tokens,this.last_token_type]=[[],null],e();const[i,n]=[this.tokens,this.last_token_type];this.tokens=s,this.last_token_type=r,"force"===t||0===i.length||i.length>1?(this.text("{"),this.text(i.join("")),this.text("}")):"text"===n?1===i[0].length?this.text(i[0]):(this.text("{"),this.text(i[0]),this.text("}")):"force_commands"===t?(this.text("{"),this.emit_token(i[0],"command"),this.text("}")):this.emit_token(i[0],"command")}text(e){if("command"===this.last_token_type){const t=this.tokens[this.tokens.length-1];this._is_latex_identifier_char(t.charAt(t.length-1))&&this._is_latex_identifier_char(e.charAt(0))&&this.emit_token(" ","text")}this.emit_token(e,"text")}_is_latex_identifier_char(e){return/^[a-zA-Z]$/.test(e)}command(e,t){t&&(e=e+"["+t+"]"),this.emit_token("\\"+e,"command")}text_or_command(e){e.startsWith("\\")?this.command(e.slice(1)):this.text(e)}begin_environment(e,t){this.text("\\begin{"+e+"}"),t&&this.text(t),this.text("\n")}end_environment(e){this.text("\n\\end{"+e+"}\n")}align_separator(){this.text(" & ")}row_separator(){this.text("\\\\[0.1em]\n")}finished_string(){return this.tokens.join("")}}class m{static from_json(e){return new m(R.from_json(e.stack),M.from_json(e.document))}constructor(e,t){this.stack=e||this._default_stack(),this.document=t||new M([],0),this.is_dirty=!1}_default_stack(){const e=B.parse_string("Welcome to the editor.  Press **[?]** to view the User Guide.");return new R([e])}same_as(e){return this.stack===e.stack&&this.document===e.document}to_json(){return{stack:this.stack.to_json(),document:this.document.to_json(),format:1}}}class x{constructor(){this.state_stack=[],this.max_stack_depth=100,this.undo_count=0}clear(e){this.state_stack=[e],this.undo_count=0}push_state(e){return this.state_stack.length>this.undo_count&&this.state_stack[this.state_stack.length-this.undo_count-1].same_as(e)?null:(this.undo_count>0&&(this.state_stack=this.state_stack.slice(0,this.state_stack.length-this.undo_count),this.undo_count=0),this.state_stack.push(e),this.state_stack.length>this.max_stack_depth&&(this.state_stack=this.state_stack.slice(this.state_stack.length-this.max_stack_depth)),e)}undo_state(){return this.state_stack.length-1>this.undo_count?(this.undo_count++,this.state_stack[this.state_stack.length-this.undo_count-1]):null}redo_state(){return this.undo_count>0?(this.undo_count--,this.state_stack[this.state_stack.length-this.undo_count-1]):null}}class f{constructor(e){this.initial_expr=e,this.expr_path_stack=[],this.max_stack_depth=100}push(e){return this.expr_path_stack.push(e),this.expr_path_stack.length>this.max_stack_depth&&(this.expr_path_stack=this.expr_path_stack.slice(this.expr_path_stack.length-this.max_stack_depth)),e}pop(){return this.expr_path_stack.length>0?this.expr_path_stack.pop():null}}class g{constructor(){this.open_request=null,this.database=null}open_database(e){indexedDB&&(this.on_open_success=e,this.open_request=indexedDB.open("rpnlatex",1),this.open_request.onupgradeneeded=this.handle_upgrade_database.bind(this),this.open_request.onsuccess=this.handle_open_success.bind(this),this.open_request.onerror=this.handle_open_error.bind(this))}handle_upgrade_database(e){if(this.database=this.open_request.result,0===e.oldVersion)this.build_initial_schema()}build_initial_schema(){this.database.createObjectStore("documents",{keyPath:"filename"}),this.database.createObjectStore("documents_metadata",{keyPath:"filename"})}handle_open_error(e){this.open_request=null}handle_open_success(e){this.database=this.open_request.result,this.open_request=null,this.database.onversionchange=()=>{this.database.close(),this.database=null,alert("Warning: database is outdated, please reload the page.")},this.on_open_success&&this.on_open_success()}create_transaction(e){return this.database.transaction(["documents","documents_metadata"],e?"readwrite":"readonly")}sanitize_filename(e){const t=e.replaceAll(/[^a-zA-Z0-9_ ]/g,"").trim();return 0===t.length||t.length>200?null:t}load_state(e,t,s){if(!this.database)return s();let r=this.create_transaction(!1).objectStore("documents").get(e);r.onsuccess=()=>{if(r.result){const s=m.from_json(r.result);t(e,s)}else s(e,"???")},r.onerror=()=>{s(e,"???")}}save_state(e,t,s,r){if(!this.database)return r();let i=e.to_json();i.filename=t;const n={filename:t,filesize:JSON.stringify(i).length,description:"",stack_item_count:e.stack.depth(),document_item_count:e.document.items.length,timestamp:new Date};let a=this.create_transaction(!0);a.objectStore("documents").put(i),a.objectStore("documents_metadata").put(n),s&&(a.oncomplete=s),r&&(a.onabort=r)}delete_state(e,t,s){if(!this.database)return s();let r=this.create_transaction(!0);r.objectStore("documents").delete(e),r.objectStore("documents_metadata").delete(e),t&&(r.oncomplete=t),s&&(r.onabort=s)}fetch_file_list(e,t){if(!this.database)return t();let s=this.create_transaction(!1).objectStore("documents_metadata").getAll();s.onsuccess=()=>{s.result.forEach((e=>{const t=Date.parse(e.timestamp);e.timestamp=t?new Date(t):null})),e(s.result)},s.onerror=t}fetch_all_documents(e,t,s){if(!this.database)return s();let r=this.create_transaction(!1).objectStore("documents").openCursor();r.onsuccess=s=>{const r=s.target.result;r?(e(r.value),r.continue()):t()},r.onerror=s}}class w{constructor(){this.state="idle",this.document_storage=null,this.import_count=0,this.failed_count=0,this.error_message=null,this.download_url=null,this.import_result_string=null,this.file_list_needs_update=!1,this.onstatechange=null}textual_state(){switch(this.state){case"idle":return this.download_url?"Download ready":"Ready for export or import";case"error":return"Error: "+this.error_message;case"loading":return"Extacting database...";case"zipping":return"Compressing files...";case"uploading":return"Uploading data...";case"importing":return"Importing documents: "+this.import_count+" so far";default:return"???"}}download_available(){return"idle"===this.state&&this.download_url}generate_download_filename(){const e=new Date;return["rpnlatex_",e.getFullYear().toString(),"_",e.toLocaleString("default",{month:"short"}).toLowerCase(),"_",e.getDate().toString().padStart(2,"0"),".zip"].join("")}change_state(e){this.state=e,this.onstatechange&&this.onstatechange(this)}start_exporting(){let e=this.document_storage;this.zip=new c.a,e.fetch_all_documents((e=>this.add_document_json_to_zip(e)),(()=>this.start_compressing()),(()=>{this.error_message="Unable to export the document database.",this.change_state("error")})),this.change_state("loading")}add_document_json_to_zip(e){this.zip.file(e.filename+".json",JSON.stringify(e))}start_compressing(){this.change_state("zipping"),this.zip.generateAsync({type:"blob"}).then((e=>{this.finished_compressing(e)}))}clear_download_url(){this.download_url&&(URL.revokeObjectURL(this.download_url),this.download_url=null)}finished_compressing(e){this.clear_download_url(),this.download_url=URL.createObjectURL(e),this.zip=null,this.change_state("idle")}start_importing(e){if(this.clear_download_url(),this.import_result_string=null,"application/zip"!==e.type)return void alert("Import files must be zip archives.");this.change_state("uploading");let t=new FileReader;t.addEventListener("load",(e=>this.process_uploaded_data(e.target.result))),t.readAsArrayBuffer(e)}process_uploaded_data(e){this.import_count=0,this.failed_count=0,this.error_message=null,this.change_state("importing"),c.a.loadAsync(e).then((e=>{let t=[];for(let s in e.files){const r=e.files[s];s.endsWith(".json")?t.push(r.async("string").then((e=>this.import_file(r.name.slice(0,r.name.length-5),e)))):(this.error_message="Invalid filename in archive: "+s,this.failed_count++)}Promise.all(t).then((()=>{this.failed_count>0?this.import_result_string="Errors encountered: "+this.error_message:this.import_result_string="Successfully imported "+this.import_count+" document"+(1===this.import_count?"":"s"),this.change_state("idle"),this.file_list_needs_update=!0}))}))}import_file(e,t){let s,r,i=this.document_storage;try{s=JSON.parse(t),r=m.from_json(s)}catch(n){return this.error_message="Invalid document found in zip file: "+e,void this.failed_count++}i.save_state(r,e),this.import_count++,this.change_state("importing")}}class y{constructor(e,t,s){this.file_list=e,this.selected_filename=t,this.current_filename=s,this.unavailable=!1}sort_file_list(e,t){this.file_list.sort(((s,r)=>{const i=s[e],n=r[e];return(t?1:-1)*(i===n?0:i<n?-1:1)}))}generate_unused_filename(e){if(this.unavailable||!this.file_list)return e;e=e.replace(/_\d+$/,"");for(let t=1;t<1e3;t++){const s=e+"_"+t;if(!this.file_list.some((e=>e.filename===s)))return s}return e+"_toomany"}find_adjacent_filename(e,t){if(this.unavailable||!this.file_list)return null;let s=null,r=this.file_list;return r.forEach(((i,n)=>{if(i.filename===e){let e=n+t;e<0&&(e=0),e>=r.length&&(e=r.length-1),s=r[e].filename}})),!s&&r.length>0&&(s=r[0].filename),s}}class b{constructor(e,t){this.expr=e,this.subexpr_indexes=t}depth(){return this.subexpr_indexes.length}equals(e){if(this.expr!==e.expr)return!1;if(this.subexpr_indexes.length!==e.subexpr_indexes.length)return!1;for(let t=0;t<this.subexpr_indexes.length;t++)if(this.subexpr_indexes[t]!==e.subexpr_indexes[t])return!1;return!0}last_expr_but(e){let t=this.expr;for(let s=0;s<this.subexpr_indexes.length-e;s++)t=t.subexpressions()[this.subexpr_indexes[s]];return t}selected_expr(){return this.last_expr_but(0)}last_index_but(e){return this.subexpr_indexes[this.subexpr_indexes.length-e]}descend(e){return new b(this.expr,this.subexpr_indexes.concat([e]))}ascend(){return new b(this.expr,this.subexpr_indexes.slice(0,-1))}move(e){const t=this.last_expr_but(1),s=this.last_index_but(1),r=t.subexpressions().length;let i=s+("right"===e?1:-1);return i<0&&(i=r-1),i>=r&&(i=0),this.ascend().descend(i)}replace_selection(e){const t=this.last_expr_but(1),s=this.last_index_but(1);let r=t.replace_subexpression(s,e);for(let i=2;i<=this.subexpr_indexes.length;i++){const e=this.last_expr_but(i),t=this.last_index_but(i);r=e.replace_subexpression(t,r)}return r}extract_selection(){return this.replace_selection(new z)}}class v{static from_json(e){switch(e.expr_type){case"command":return new k(e.command_name,this._list(e.operand_exprs),e.options);case"infix":return new j(this._list(e.operand_exprs),this._list(e.operator_exprs),e.split_at_index||null,e.split_type||null);case"placeholder":return new z;case"text":return new E(e.text);case"sequence":return new C(this._list(e.exprs),!!e.fused);case"delimiter":return new q(e.left_type,e.right_type,e.middle_type,this._list(e.inner_exprs),e.fixed_size);case"subscriptsuperscript":return new A(this._expr(e.base_expr),this._expr(e.subscript_expr),this._expr(e.superscript_expr));case"array":return new S(e.array_type,e.row_count,e.column_count,this._list2d(e.element_exprs),e.row_separators,e.column_separators);default:return new E("invalid expr type "+e.expr_type)}}static _expr(e){return e?v.from_json(e):null}static _list(e){return e.map((e=>v.from_json(e)))}static _list2d(e){return e.map((e=>v._list(e)))}static combine_pair(e,t){const s=e.expr_type(),r=t.expr_type();return"sequence"!==s||e.fused||"sequence"!==r||t.fused?"text"===s&&"text"===r?new E(e.text+t.text):"sequence"!==s||e.fused||"text"!==r||"text"!==e.exprs[e.exprs.length-1].expr_type()?"text"!==s||"sequence"!==r||t.fused||"text"!==t.exprs[0].expr_type()?"sequence"!==s||e.fused?"sequence"!==r||t.fused?"command"===s&&"command"===r?v.combine_command_pair(e,t):new C([e,t]):new C([e].concat(t.exprs)):new C(e.exprs.concat([t])):new C([new E(e.text+t.exprs[0].text)].concat(t.exprs.slice(1))):new C(e.exprs.slice(0,-1).concat([new E(e.exprs[e.exprs.length-1].text+t.text)])):new C(e.exprs.concat(t.exprs))}static combine_command_pair(e,t){const s=e.command_name,r=t.command_name;if("boldsymbol"===s&&"boldsymbol"===r&&1===e.operand_count()&&1===t.operand_count())return new C([e.operand_exprs[0],t.operand_exprs[0]]).as_bold();let i=null;return"int"===s&&"int"===r&&(i="iint"),"iint"===s&&"int"===r&&(i="iiint"),"int"===s&&"iint"===r&&(i="iiint"),"oint"===s&&"oint"===r&&(i="oiint"),"oiint"===s&&"oint"===r&&(i="oiiint"),"oint"===s&&"oiint"===r&&(i="oiiint"),i?new k(i):new C([e,t])}static text_or_command(e){return e.startsWith("\\")?new k(e.slice(1)):new E(e)}expr_type(){return"???"}to_latex(e){let t=new d(this,e);return t.expr(this,null),t.finished_string()}emit_latex(e){e.text("INVALID")}json_keys(){return[]}to_json(){let e={expr_type:this.expr_type()};return this.json_keys().forEach((t=>{const s=this[t];let r;r=null===s||void 0===s?null:"object"===typeof s&&s instanceof v?s.to_json():"object"===typeof s?s.map((e=>e.to_json())):s,e[t]=r})),e}to_text(){return"$$\n"+this.to_latex()+"\n$$"}visit(e){e(this)}subexpressions(){return[]}has_subexpressions(){return this.subexpressions().length>0}replace_subexpression(e,t){return this}find_placeholder(){let e=null;return this.visit((t=>{"placeholder"!==t.expr_type()||e||(e=t)})),e}substitute_expr(e,t){return this===e?t:this}as_bold(){return new k("boldsymbol",[this])}is_command_with_name(e){return!1}}class k extends v{constructor(e,t,s){if(super(),e.endsWith("]")){const t=e.indexOf("[");this.command_name=e.slice(0,t),this.options=e.slice(t+1,e.length-1)}else this.command_name=e,this.options=void 0===s?null:s;this.operand_exprs=t||[]}operand_count(){return this.operand_exprs.length}expr_type(){return"command"}json_keys(){return["command_name","operand_exprs","options"]}emit_latex(e){""!==this.command_name&&e.command(this.command_name,this.options),this.operand_exprs.forEach(((t,s)=>e.grouped_expr(t,"force",s)))}visit(e){e(this),this.operand_exprs.forEach((t=>t.visit(e)))}subexpressions(){return this.operand_exprs}has_subexpressions(){return this.is_font_command()?this.operand_exprs[0].has_subexpressions():super.has_subexpressions()}replace_subexpression(e,t){return new k(this.command_name,this.operand_exprs.map(((s,r)=>r===e?t:s)),this.options)}substitute_expr(e,t){return this===e?t:new k(this.command_name,this.operand_exprs.map((s=>s.substitute_expr(e,t))),this.options)}as_bold(){return"boldsymbol"===this.command_name?this:"mathrm"===this.command_name?1===this.operand_count()?new k("bold",this.operand_exprs):this:"mathtt"===this.command_name||"mathsf"===this.command_name||"mathbb"===this.command_name||"mathfrak"===this.command_name||"mathscr"===this.command_name||"mathcal"===this.command_name?1===this.operand_count()?new k("pmb",[this]):this:super.as_bold()}is_command_with_name(e){return this.command_name===e}is_font_command(){if(1!==this.operand_count())return!1;const e=this.command_name;return"boldsymbol"===e||"bold"===e||"pmb"===e||"mathrm"===e||"mathtt"===e||"mathsf"===e||"mathbb"===e||"mathfrak"===e||"mathscr"===e||"mathcal"===e}}class j extends v{static combine_infix(e,t,s){let r=[],i=[];"infix"!==e.expr_type()||e.split_type?r.push(e):(r=r.concat(e.operand_exprs),i=i.concat(e.operator_exprs));const n=i.length;return i.push(s),"infix"!==t.expr_type()||t.split_type?r.push(t):(r=r.concat(t.operand_exprs),i=i.concat(t.operator_exprs)),new j(r,i,n)}constructor(e,t,s,r){super(),this.operand_exprs=e,this.operator_exprs=t,this.split_at_index=s||0,this.split_type=r}expr_type(){return"infix"}json_keys(){return["operand_exprs","operator_exprs","split_at_index","split_type"]}operator_text(e){return e?"command"===e.expr_type()&&0===e.operand_count()?e.command_name:"text"===e.expr_type()?e.text:null:this.operator_text(this.operator_exprs[this.split_at_index])}needs_autoparenthesization(){return this.operator_exprs.every((e=>{const t=this.operator_text(e);return t&&("+"===t||"-"===t)}))}emit_latex(e){for(let t=0;t<this.operator_exprs.length;t++)e.expr(this.operand_exprs[t],2*t),this.split_at_index===t&&"before"===this.split_type&&(e.command("\\"),e.command("qquad")),e.expr(this.operator_exprs[t],2*t+1),this.split_at_index===t&&"after"===this.split_type&&(e.command("\\"),e.command("qquad"));e.expr(this.operand_exprs[this.operand_exprs.length-1],2*this.operator_exprs.length)}visit(e){e(this);for(let t=0;t<this.operator_exprs.length;t++)this.operand_exprs[t].visit(e),this.operator_exprs[t].visit(e);this.operand_exprs[this.operand_exprs.length-1].visit(e)}subexpressions(){let e=[];for(let t=0;t<this.operator_exprs.length;t++)e.push(this.operand_exprs[t]),e.push(this.operator_exprs[t]);return e.push(this.operand_exprs[this.operand_exprs.length-1]),e}replace_subexpression(e,t){return new j(this.operand_exprs.map(((s,r)=>2*r===e?t:s)),this.operator_exprs.map(((s,r)=>2*r+1===e?t:s)),this.split_at_index,this.split_type)}substitute_expr(e,t){return this===e?t:new j(this.operand_exprs.map((s=>s.substitute_expr(e,t))),this.operator_exprs.map((s=>s.substitute_expr(e,t))),this.split_at_index,this.split_type)}with_split_at(e,t){return new j(this.operand_exprs,this.operator_exprs,e,t)}swap_sides_at(e){const t=this.operand_exprs.slice(e+1).concat(this.operand_exprs.slice(0,e+1)),s=this.operator_exprs.slice(e+1).concat([this.operator_exprs[e]]).concat(this.operator_exprs.slice(0,e));return new j(t,s,s.length-this.split_at_index-1,this.split_type)}extract_side_at(e,t){return"right"===t?e===this.operator_exprs.length-1?this.operand_exprs[e+1]:new j(this.operand_exprs.slice(e+1),this.operator_exprs.slice(e+1),0,null):0===e?this.operand_exprs[0]:new j(this.operand_exprs.slice(0,e+1),this.operator_exprs.slice(0,e),0,null)}}class z extends v{expr_type(){return"placeholder"}json_keys(){return[]}emit_latex(e){const t=new k("htmlClass",[new E("placeholder_expr"),new E("\\blacksquare")]);e.expr(t,null)}}class E extends v{static blank(){return new E("")}constructor(e){super(),this.text=e}expr_type(){return"text"}json_keys(){return["text"]}emit_latex(e){e.text(this.text,null)}}class C extends v{constructor(e,t){super(),this.exprs=e,this.fused=!!t}expr_type(){return"sequence"}json_keys(){return["exprs"]}to_json(){let e=super.to_json();return this.fused&&(e.fused=!0),e}emit_latex(e){2===this.exprs.length&&"delimiter"===this.exprs[1].expr_type()?(e.expr(this.exprs[0],0),e.grouped_expr(this.exprs[1],"force",1)):this.exprs.forEach(((t,s)=>e.expr(t,s)))}visit(e){e(this),this.exprs.forEach((t=>t.visit(e)))}subexpressions(){return this.exprs}replace_subexpression(e,t){return new C(this.exprs.map(((s,r)=>r===e?t:s)))}substitute_expr(e,t){return this===e?t:new C(this.exprs.map((s=>s.substitute_expr(e,t))))}}class q extends v{static parenthesize(e){return new q("(",")",null,[e])}static autoparenthesize(e){return"infix"===e.expr_type()&&e.needs_autoparenthesization()?q.parenthesize(e):e}static autoparenthesize_frac(e){return"command"===e.expr_type()&&"frac"===e.command_name&&2===e.operand_count()||"infix"===e.expr_type()&&"/"===e.operator_text()||"delimiter"===e.expr_type()&&"."===e.left_type&&"/"===e.middle_type&&"."===e.right_type?q.parenthesize(e):e}constructor(e,t,s,r,i){super(),this.left_type=e,this.right_type=t,this.middle_type=s||null,this.fixed_size=i||!1,this.inner_exprs=r||[]}expr_type(){return"delimiter"}json_keys(){return["left_type","right_type","middle_type","inner_exprs"]}emit_latex(e){this.fixed_size?this.emit_latex_fixed_size(e):this.emit_latex_flex_size(e)}emit_latex_flex_size(e){e.command("left"),e.text_or_command(this.left_type),this.inner_exprs.forEach(((t,s)=>{s>0&&(e.command("middle"),e.text_or_command(this.middle_type||"|")),e.expr(t,s)})),e.command("right"),e.text_or_command(this.right_type)}emit_latex_fixed_size(e){"."!==this.left_type&&e.text_or_command(this.left_type),this.inner_exprs.forEach(((t,s)=>{s>0&&"."!==this.middle_type&&e.text_or_command(this.middle_type||"|"),e.expr(t,s)})),"."!==this.right_type&&e.text_or_command(this.right_type)}as_fixed_size(e){return new q(this.left_type,this.right_type,this.middle_type,this.inner_exprs,e)}without_delimiters(){return 1===this.inner_exprs.length?this.inner_exprs[0]:new q(".",".",this.middle_type,this.inner_exprs,this.fixed_size)}to_json(){let e=super.to_json();return this.fixed_size&&(e.fixed_size=!0),e}visit(e){e(this),this.inner_exprs.forEach((t=>t.visit(e)))}subexpressions(){return this.inner_exprs}replace_subexpression(e,t){return new q(this.left_type,this.right_type,this.middle_type,this.inner_exprs.map(((s,r)=>r===e?t:s)))}substitute_expr(e,t){return this===e?t:new q(this.left_type,this.right_type,this.middle_type,this.inner_exprs.map((s=>s.substitute_expr(e,t))))}}class A extends v{constructor(e,t,s){super(),this.base_expr=e,this.subscript_expr=t,this.superscript_expr=s}expr_type(){return"subscriptsuperscript"}json_keys(){return["base_expr","subscript_expr","superscript_expr"]}emit_latex(e){"command"===this.base_expr.expr_type()?e.expr(this.base_expr,0):e.grouped_expr(this.base_expr,!1,0);let t=1;this.superscript_expr&&(e.text("^"),e.grouped_expr(this.superscript_expr,"force_commands",t),t++),this.subscript_expr&&(e.text("_"),e.grouped_expr(this.subscript_expr,"force_commands",t))}visit(e){e(this),this.base_expr.visit(e),this.subscript_expr&&this.subscript_expr.visit(e),this.superscript_expr&&this.superscript_expr.visit(e)}subexpressions(){let e=[this.base_expr];return this.superscript_expr&&e.push(this.superscript_expr),this.subscript_expr&&e.push(this.subscript_expr),e}replace_subexpression(e,t){return new A(0===e?t:this.base_expr,2===e||!this.superscript_expr&&1===e?t:this.subscript_expr,1===e&&this.superscript_expr?t:this.superscript_expr)}substitute_expr(e,t){return this===e?t:new A(this.base_expr.substitute_expr(e,t),this.subscript_expr?this.subscript_expr.substitute_expr(e,t):null,this.superscript_expr?this.superscript_expr.substitute_expr(e,t):null)}is_command_with_name(e){return this.base_expr.is_command_with_name(e)}}class S extends v{static stack_arrays(e,t){return e.column_count!==t.column_count?null:new S(t.array_type,e.row_count+t.row_count,e.column_count,e.element_exprs.concat(t.element_exprs),e.row_separators.concat([null],t.row_separators),t.column_separators)}static split_elements(e,t){return e.map((e=>S._split_expr(e,t)))}static _split_expr(e,t){switch(t){case"none":default:return[e];case"infix":return"infix"===e.expr_type()?[e.extract_side_at(e.split_at_index,"left"),j.combine_infix(E.blank(),e.extract_side_at(e.split_at_index,"right"),e.operator_exprs[e.split_at_index])]:[e,null];case"colon":return"infix"===e.expr_type()&&":"===e.operator_text()?[e.extract_side_at(e.split_at_index,"left"),e.extract_side_at(e.split_at_index,"right")]:[e,null];case"colon_if":return"infix"===e.expr_type()&&":"===e.operator_text()?[e.extract_side_at(e.split_at_index,"left"),v.combine_pair(v.combine_pair(new k("mathrm",[new E("if")]),new k("enspace"),[]),e.extract_side_at(e.split_at_index,"right"))]:[e,new k("mathrm",[new E("otherwise")])]}}constructor(e,t,s,r,i,n){super(),this.array_type=e,this.row_count=t,this.column_count=s,this.element_exprs=r,this.row_separators=i||new Array(t-1).fill(null),this.column_separators=n||new Array(s-1).fill(null)}expr_type(){return"array"}json_keys(){return["array_type","row_count","column_count"]}is_matrix(){const e=this.array_type;return"bmatrix"===e||"Bmatrix"===e||"matrix"===e||"pmatrix"===e||"vmatrix"===e||"Vmatrix"===e}with_array_type(e){return new S(e,this.row_count,this.column_count,this.element_exprs,this.row_separators,this.column_separators)}as_bold(){return new S(this.array_type,this.row_count,this.column_count,this.element_exprs.map((e=>e.map((e=>e.as_bold())))),this.row_separators,this.column_separators)}to_json(){let e=super.to_json();return e.element_exprs=this.element_exprs.map((e=>e.map((e=>e.to_json())))),this.row_separators.every((e=>null===e))||(e.row_separators=this.row_separators),this.column_separators.every((e=>null===e))||(e.column_separators=this.column_separators),e}with_ellipses(){const e=e=>new E(e);let t,s=this.row_count,r=this.column_count;if(this.column_count>1?(t=this.element_exprs.map(((t,s)=>[...t.slice(0,-1),e(0===s||s===this.row_count-1?"\\cdots":""),t[this.column_count-1]])),r++):t=[...this.element_exprs],this.row_count>1){let r=[e("\\vdots")];for(let t=0;t<this.column_count-2;t++)r.push(e(""));this.column_count>1&&r.push(e("\\ddots"),e("\\vdots")),t.splice(this.row_count-1,0,r),s++}return new S(this.array_type,s,r,t)}transposed(){let e=[];for(let t=0;t<this.column_count;t++)e.push(this.element_exprs.map((e=>this._transpose_cell(e[t]))));return new S(this.array_type,this.column_count,this.row_count,e,this.column_separators,this.row_separators)}_transpose_cell(e){if("text"===e.expr_type())switch(e.text){case"\\vdots":return new E("\\cdots");case"\\cdots":return new E("\\vdots")}return e}split_rows(){return this.element_exprs.map((e=>new S(this.array_type,1,this.column_count,[e],this.column_separators,null)))}with_separator(e,t,s,r){const i=[...this.row_separators],n=[...this.column_separators],a=e?n:i,o=e?this.column_count:this.row_count;if(null===t){r&&a.every((e=>e===s))&&(s=null);for(let e=0;e<o-1;e++)a[e]=s}else{if(t<0||t>=o-1)return this;r&&a[t]===s&&(s=null),a[t]=s}return new S(this.array_type,this.row_count,this.column_count,this.element_exprs,i,n)}emit_latex(e){if(this.is_matrix()&&(!this.column_separators.every((e=>null===e))||!this.row_separators.every((e=>null===e))))return this._emit_array_with_separators(e);let t=0;"substack"===this.array_type?e.text("\\substack{\n"):e.begin_environment(this.array_type),this.element_exprs.forEach(((s,r)=>{r>0&&e.row_separator(),s.forEach(((s,r)=>{r>0&&e.align_separator(),s&&e.expr(s,t),t++}))})),"substack"===this.array_type?e.text("}"):e.end_environment(this.array_type)}_emit_array_with_separators(e){let t=null,s=null;switch(this.array_type){case"bmatrix":t="[",s="]";break;case"Bmatrix":t="\\{",s="\\}";break;case"matrix":t=null,s=null;break;case"pmatrix":t="(",s=")";break;case"vmatrix":t=s="|";break;case"Vmatrix":t=s="\\Vert"}let r=["{"];for(let o=0;o<this.column_count;o++)if(r.push("c"),o<this.column_count-1){const e=this.column_separators[o];"solid"===e?r.push("|"):"dashed"===e&&r.push(":")}r.push("}");const i=r.join("");t&&(e.command("left"),e.text_or_command(t));const n=!this.row_separators.every((e=>null===e));n||e.text_or_command("\\kern-5pt"),e.begin_environment("array",i);let a=0;this.element_exprs.forEach(((t,s)=>{if(s>0){e.row_separator();const t=this.row_separators[s-1];t&&("solid"===t?e.command("hline"):"dashed"===t&&e.command("hdashline"),e.text("\n"))}t.forEach(((t,s)=>{s>0&&e.align_separator(),t&&e.expr(t,a),a++}))})),e.end_environment("array"),n||e.text_or_command("\\kern-5pt"),s&&(e.command("right"),e.text_or_command(s))}visit(e){e(this),this.element_exprs.forEach((t=>t.forEach((t=>t.visit(e)))))}subexpressions(){return[].concat(...this.element_exprs)}replace_subexpression(e,t){const s=e%this.column_count,r=Math.floor((e-s)/this.column_count),i=this.element_exprs.map(((e,i)=>e.map(((e,n)=>i===r&&n===s?t:e))));return new S(this.array_type,this.row_count,this.column_count,i,this.row_separators,this.column_separators)}substitute_expr(e,t){if(this===e)return t;const s=this.element_exprs.map((s=>s.map((s=>s.substitute_expr(e,t)))));return new S(this.array_type,this.row_count,this.column_count,s,this.row_separators,this.column_separators)}}class N{static next_serial(){return N.serial_number++}static from_json(e){switch(e.item_type){case"expr":return new L(v.from_json(e.expr),e.tag_expr?v.from_json(e.tag_expr):null);case"text":return new B(e.elements.map((e=>T.from_json(e))),!!e.is_heading);case"code":return new P(e.language,e.source);default:return B.from_string("invalid item type "+e.item_type)}}constructor(){this.serial=N.next_serial()}react_key(e){return e+"_"+this.serial}item_type(){return"???"}to_json(){return{}}to_text(){return"???"}clone(){return null}}N.serial_number=1;class L extends N{constructor(e,t,s){super(),this.expr=e,this.tag_expr=t,this.selected_expr_path=s}item_type(){return"expr"}to_latex(){return this.expr.to_latex(this.selected_expr_path)}to_json(){let e={item_type:"expr",expr:this.expr.to_json()};return this.tag_expr&&(e.tag_expr=this.tag_expr.to_json()),e}to_text(){return this.expr.to_text()}clone(){return new L(this.expr,this.tag_expr)}as_bold(){return new L(this.expr.as_bold(),this.tag_expr)}}class T{static from_json(e){return e.expr?new I(v.from_json(e.expr)):e.text?new D(e.text,!!e.is_bold,!!e.is_italic):new U(e.raw)}is_text(){return!1}is_expr(){return!1}is_raw(){return!1}}class D extends T{constructor(e,t,s){super(),this.text=e,this.is_bold=!!t,this.is_italic=!!s}is_text(){return!0}as_bold(){return new D(this.text,!0)}to_json(){let e={text:this.text};return this.is_bold&&(e.is_bold=!0),this.is_italic&&(e.is_italic=!0),e}to_text(){return this.is_bold?["**",this.text,"**"].join(""):this.is_italic?["//",this.text,"//"].join(""):this.text}to_latex(){const e=this.text.split(/ +/);let t=[];for(let s=0;s<e.length;s++)t.push("\\text{"),this.is_bold?t.push("\\bf{}"):this.is_italic&&t.push("\\it{}"),t.push(this._latex_escape(e[s])),s<e.length-1&&t.push(" "),t.push("}\\allowbreak ");return t.join("")}_latex_escape(e){const t={_:"\\_","^":"\\textasciicircum","%":"\\%",$:"\\$","&":"\\&","#":"\\#","}":"\\}","{":"\\{","~":"\\textasciitilde","\\":"\\textbackslash "};return e.replaceAll(/[_^%$&#}{~\\]/g,(e=>t[e]))}}class I extends T{constructor(e){super(),this.expr=e}is_expr(){return!0}as_bold(){return new I(this.expr.as_bold())}to_json(){return{expr:this.expr.to_json()}}to_text(){return"$"+this.expr.to_latex()+"$"}to_latex(){return this.expr.to_latex()}}class U extends T{constructor(e){super(),this.string=e}is_raw(){return!0}as_bold(){return this}to_json(){return{raw:this.string}}to_text(){return this.string}to_latex(){return this.string}is_explicit_space(){return"\\,"===this.string}}class B extends N{static from_expr(e){return new B([new I(e)])}static from_string(e){return new B([new D(e)])}static empty_item(){return new B([],!0)}static parse_string(e){const t=e.split("[]");let s=[];for(let r=0;r<t.length;r++){const e=t[r].split("**");for(let t=0;t<e.length;t++){const r=t%2===1&&t<e.length-1;if(e[t].length>0)if(r)s.push(new D(e[t],r));else{const r=e[t].split("//");for(let e=0;e<r.length;e++){const t=e%2===1&&e<r.length-1;r[e].length>0&&s.push(new D(r[e],!1,t))}}}r<t.length-1&&s.push(new I(new z))}return new B(s)}static concatenate_items(e,t,s){"expr"===e.item_type()&&(e=B.from_expr(e.expr)),"expr"===t.item_type()&&(t=B.from_expr(t.expr));const r=e.elements.concat(s?[new U(s)]:[],t.elements);let i=[r[0]];for(let n=1;n<r.length;n++){const e=i.length-1,t=i[e];t.is_text()&&r[n].is_text()&&t.is_bold===r[n].is_bold&&t.is_italic===r[n].is_italic?i[e]=new D(t.text+r[n].text,r[n].is_bold,r[n].is_italic):t.is_raw()&&t.is_explicit_space()&&r[n].is_text()?i[e]=new D(" "+r[n].text,r[n].is_bold,r[n].is_italic):t.is_text()&&r[n].is_raw()&&r[n].is_explicit_space()?i[e]=new D(t.text+" ",t.is_bold,t.is_italic):i.push(r[n])}return new B(i,e.is_heading||t.is_heading)}constructor(e,t){super(),this.elements=e,this.is_heading=!!t}item_type(){return"text"}to_json(){let e={item_type:"text",elements:this.elements.map((e=>e.to_json()))};return this.is_heading&&(e.is_heading=!0),e}is_empty(){return 0===this.elements.length}to_text(){return this.is_empty()?"\\rule":this.elements.map((e=>e.to_text())).join("")}to_latex(){return this.elements.map((e=>e.to_latex())).join("")}clone(){return new B(this.elements,this.is_heading)}as_editable_string(){let e=[];for(let t=0;t<this.elements.length;t++){const s=this.elements[t];if(s.is_text())e.push(s.to_text());else if(s.is_raw()){if(!s.is_explicit_space())return null;e.push(" ")}else if(s.is_expr()){if("placeholder"!==s.expr.expr_type())return null;e.push("[]")}}return e.join("")}as_bold(){return new B(this.elements.map((e=>e.as_bold())),this.is_heading)}try_substitute_placeholder(e){let t=[...this.elements];for(let s=0;s<t.length;s++)if(t[s].is_expr()){const r=t[s].expr.find_placeholder();if(r){const i=t[s].expr.substitute_expr(r,e);return t[s]=new I(i),new B(t,this.is_heading)}}return null}}class P extends N{static from_latex_string(e){return new P("latex",e)}constructor(e,t){super(),this.language=e,this.source=t}item_type(){return"code"}to_json(){return{item_type:"code",language:this.language,source:this.source}}to_latex(){return"???"}clone(){return new P(this.language,this.source)}as_bold(){return this.clone()}}class R{static from_json(e){return new R(e.items.map((e=>N.from_json(e))))}constructor(e){this.items=e}depth(){return this.items.length}check(e){return this.depth()>=e}check_exprs(e){if(!this.check(e))return!1;for(let t=0;t<e;t++)if("expr"!==this.items[this.items.length-1-t].item_type())return!1;return!0}peek(e){return this.check(1)||this.underflow(),this.items[this.items.length-e]}pop(e){return void 0===e&&(e=1),this.check(e)||this.underflow(),this._unchecked_pop(e)}pop_exprs(e){this.check(e)||this.underflow(),this.check_exprs(e)||this.type_error();const[t,...s]=this._unchecked_pop(e);return[t,...s.map((e=>e.expr))]}pop_arrays(e){const[t,...s]=this.pop_exprs(e);if(s.every((e=>"array"===e.expr_type())))return[t,...s];this.type_error()}pop_matrices(e){const[t,...s]=this.pop_arrays(e);if(s.every((e=>e.is_matrix())))return[t,...s];this.type_error()}_unchecked_pop(e){return[new R(this.items.slice(0,-e))].concat(this.items.slice(-e))}push_all(e){if(!e.every((e=>e instanceof N)))throw new Error("pushing invalid item onto stack");return new R(this.items.concat(e))}push_all_exprs(e){return this.push_all(e.map((e=>new L(e))))}push(e){return this.push_all([e])}push_expr(e){return this.push_all_exprs([e])}clone_all_items(){return new R(this.items.map((e=>e.clone())))}underflow(){throw new Error("stack_underflow")}type_error(){throw new Error("stack_type_error")}to_json(){return{object_type:"stack",items:this.items.map((e=>e.to_json()))}}}class M{static from_json(e){return new M(e.items.map((e=>N.from_json(e))),e.selection_index||0)}constructor(e,t){this.items=e||[],this.selection_index=t}selected_item(){return this.selection_index>0?this.items[this.selection_index-1]:null}insert_item(e){const t=this.selection_index,s=this.items.slice(0,t).concat([e],this.items.slice(t));return new M(s,t+1)}delete_selection(){const e=this.selection_index;if(e>0){const t=this.items.slice(0,e-1).concat(this.items.slice(e));return new M(t,e-1)}return null}move_selection_by(e){let t=this.selection_index+e;return t<0&&(t=0),t>this.items.length&&(t=this.items.length),new M(this.items,t)}shift_selection_by(e){const t=this.selected_item();return!t||this.selection_index+e<=0||this.selection_index+e>this.items.length?null:this.delete_selection().move_selection_by(e).insert_item(t)}clone_all_items(){return new M(this.items.map((e=>e.clone())),this.selection_index)}to_json(){return{object_type:"document",items:this.items.map((e=>e.to_json())),selection_index:this.selection_index}}to_text(){return this.items.map((e=>e.to_text())).join("\n\n")}}class O{constructor(e,t,s){this.mode=e,this.current_text=t||"",this.cursor_position=this.current_text.length,this.edited_item=s}is_empty(){return 0===this.current_text.length}insert(e){this.current_text=[this.current_text.slice(0,this.cursor_position),e,this.current_text.slice(this.cursor_position)].join(""),this.cursor_position++}backspace(){this.cursor_position>0&&(this.cursor_position--,this.current_text=[this.current_text.slice(0,this.cursor_position),this.current_text.slice(this.cursor_position+1)].join(""))}left(){this.cursor_position>0&&this.cursor_position--}right(){this.cursor_position<this.current_text.length&&this.cursor_position++}}var V=class{constructor(e,t){this.app_component=e,this.settings=t,this.mode="base",this.new_mode=null,this.new_document=null,this.files_changed=!1,this.file_saved=!1,this.notification_text=null,this.perform_undo_or_redo=null,this.prefix_argument=null,this.preserve_prefix_argument=!1,this.text_entry=null,this.custom_delimiters={},this.dissect_undo_stack=null}handle_key(e,t){if("Shift"===t||"Alt"===t||"Control"===t)return[!1,e];const s=this.settings.popup_mode||this.mode,r=this.settings.current_keymap.lookup_binding(s,t);if(r){this.last_keypress=t;return[!0,this.process_command(r,e)||e]}return[!1,e]}process_command(e,t){const s=e.split(";").map((e=>e.split(" ").map((e=>e.replaceAll("semicolon",";")))));return this.process_command_batch(s,t)}process_command_batch(e,t){this.perform_undo_or_redo=null;for(let r=0;r<e.length;r++){const[i,...n]=e[r],a=this["do_"+i];if(!a)return null;try{this.app_state=t,this.new_mode=null,this.new_document=null,this.files_changed=!1,this.file_saved=!1,this.preserve_prefix_argument=!1,this.notification_text=null;const e=a.bind(this)(t.stack,...n);let s=new m(e||t.stack,this.new_document||t.document);s.is_dirty=t.is_dirty||!s.same_as(t),this.file_saved&&(s.is_dirty=!1),t=s,this.mode=this.new_mode||"base",this.preserve_prefix_argument||(this.prefix_argument=null)}catch(s){if("stack_underflow"===s.message||"stack_type_error"===s.message||"prefix_argument_required"===s.message)return this.error_flash_stack(),this.perform_undo_or_redo=null,this.mode="base",this.prefix_argument=null,null;throw s}finally{this.app_state=null,this.new_document=null}}return t}switch_to_mode(e){this.new_mode=e}error_flash_element(e){e.classList.remove("errorflash"),e.offsetWidth,e.classList.add("errorflash")}error_flash_stack(){return 0===this.settings.layout.stack_split?this.error_flash_document():this.error_flash_element(document.getElementById("stack_panel"))}error_flash_document(){return 100===this.settings.layout.stack_split?this.error_flash_stack():this.error_flash_element(document.getElementById("document_panel"))}clear_all_flashes(){["stack_panel","document_panel"].forEach((e=>document.getElementById(e).classList.remove("errorflash")))}notify(e){this.notification_text=e}_build_subscript_superscript(e,t,s){return"subscriptsuperscript"===e.expr_type()&&(null===e.subscript_expr&&!s||null===e.superscript_expr&&s)?new A(e.base_expr,s?e.subscript_expr:t,s?t:e.superscript_expr):(e=q.autoparenthesize(e),e=q.autoparenthesize_frac(e),new A(e,s?null:t,s?t:null))}make_subscript_superscript(e,t){const[s,r,i]=e.pop_exprs(2),n=this._build_subscript_superscript(r,i,t);return s.push_expr(n)}do_subscript(e){return this.make_subscript_superscript(e,!1)}do_superscript(e){return this.make_subscript_superscript(e,!0)}do_prime(e){const[t,s]=e.pop_exprs(1),r=new k("prime",[]);if("subscriptsuperscript"===s.expr_type()&&s.superscript_expr){const e=s.superscript_expr,i=e=>"command"===e.expr_type()&&0===e.operand_count()&&"prime"===e.command_name;let n;if(n=i(e)?new C([e,r]):"sequence"===e.expr_type()&&e.exprs.every(i)?new C(e.exprs.concat([r])):null,n){const e=new A(s.base_expr,s.subscript_expr,n);return t.push_expr(e)}}const i=this._build_subscript_superscript(s,r,!0);return t.push_expr(i)}do_mode(e,t){this.switch_to_mode(t)}do_undo(){this.perform_undo_or_redo="undo"}do_redo(){this.perform_undo_or_redo="redo"}do_prefix_argument(){const e=this.last_keypress;this.perform_undo_or_redo="suppress",this.switch_to_mode(this.mode),this.preserve_prefix_argument=!0;let t=null;if(/^[0-9]$/.test(e)){const s=parseInt(e);t=null!==this.prefix_argument&&this.prefix_argument>0?10*this.prefix_argument+s:s}else"*"===e&&(t=-1);this.prefix_argument=t}_get_prefix_argument(e,t){return null===this.prefix_argument?e:this.prefix_argument<0?t:this.prefix_argument}_require_prefix_argument(e){if(null===this.prefix_argument||e&&0===this.prefix_argument||!e&&this.prefix_argument<=0)throw new Error("prefix_argument_required");return this.prefix_argument}do_dup(e){const t=this._get_prefix_argument(1,e.depth()),[s,...r]=e.pop(t),i=r.map((e=>e.clone()));return s.push_all(r.concat(i))}do_pop(e){const t=this._get_prefix_argument(1,e.depth()),[s,...r]=e.pop(t);return s}do_nip(e){const t=this._get_prefix_argument(2,e.depth()),[s,...r]=e.pop(t);return s.push_all(r.slice(1))}do_swap(e){const t=this._get_prefix_argument(2,e.depth()),[s,...r]=e.pop(t);return r.reverse(),s.push_all(r)}do_tuck(e){const t=this._get_prefix_argument(2,e.depth()),[s,...r]=e.pop(t),i=r[r.length-1];return s.push_all([i.clone()].concat(r))}do_over(e){const t=this._get_prefix_argument(2,e.depth()),[s,...r]=e.pop(t);return s.push_all(r.concat([r[0].clone()]))}do_rot(e){const t=this._get_prefix_argument(3,e.depth()),[s,...r]=e.pop(t),i=r.slice(1).concat([r[0]]);return s.push_all(i)}do_unrot(e){const t=this._get_prefix_argument(3,e.depth()),[s,...r]=e.pop(t),i=r.slice(-1).concat(r.slice(0,-1));return s.push_all(i)}do_change_document_selection(e,t){const s=parseInt(t);this.new_document=this.app_state.document.move_selection_by(s)}do_shift_document_selection(e,t){const s=parseInt(t),r=this.app_state.document.shift_selection_by(s);r?this.new_document=r:this.error_flash_document()}do_save_file(e){const t=this.app_component.state.file_manager_state.current_filename;if(!t)return this.do_save_file_as(e);this.app_component.state.document_storage.save_state(this.app_state,t,(()=>{this.notify("Saved: "+t),this.settings.last_opened_filename=t,this.settings.save(),this.perform_undo_or_redo="clear",this.app_component.request_file_list()}),(()=>this.notify("Error saving:"+t))),this.file_saved=!0}do_save_file_as(e){let t=window.prompt("Enter the filename to save as",this.settings.current_filename);if(!t)return;let s=this.app_component.state.document_storage;t=s.sanitize_filename(t),s.save_state(this.app_state,t,(()=>{this.notify("Saved as: "+t);let e=this.app_component.state.file_manager_state;e.selected_filename=e.current_filename=t,this.settings.last_opened_filename=t,this.settings.save(),this.perform_undo_or_redo="clear",this.app_component.request_file_list()}),(()=>this.notify("Error saving: "+t))),this.file_saved=!0}do_load_selected_file(e){const t=this.app_component.state.file_manager_state.selected_filename;return t?this.app_state.is_dirty&&window.confirm("The current document has been modified.  Save it now?")?this.do_save_file(e):void this.app_component.start_loading_filename(t):this.error_flash_document()}do_start_new_file(e){let t=this.app_component.state.file_manager_state,s=this.app_component.state.document_storage,r=t.generate_unused_filename(t.current_filename||"untitled");if(r=window.prompt("Enter a filename for the new document",r),!r)return;if(r=s.sanitize_filename(r||""),!r)return void alert("Invalid filename (must only contain letters, numbers and underscores)");t.current_filename&&s.save_state(this.app_state,t.current_filename);let i=new m;return this.new_document=i.document,t.selected_filename=t.current_filename=r,this.settings.last_opened_filename=r,this.settings.save(),this.perform_undo_or_redo="clear",this.notify("Started new file: "+r),this.files_changed=!0,this.file_saved=!0,this.do_toggle_popup(i.stack,"files"),i.stack}do_select_adjacent_file(e,t){const s=parseInt(t);let r=this.app_component.state.file_manager_state;const i=r.find_adjacent_filename(r.selected_filename,s);i&&(r.selected_filename=i,this.files_changed=!0)}do_delete_selected_file(e){let t=this.app_component.state.file_manager_state,s=this.app_component.state.document_storage;const r=t.selected_filename;if(!r)return this.error_flash_document();window.confirm('Really delete "'+r+'"?')&&s.delete_state(r,(()=>{this.notify("Deleted: "+r);const e=t.find_adjacent_filename(r,1);t.selected_filename=e,this.settings.last_opened_filename=e,this.settings.save(),this.app_component.request_file_list()}),(()=>this.notify("Error deleting: "+r)))}do_pop_to_document(e,t){const s=this._get_prefix_argument(1,e.depth()),[r,...i]=e.pop(s);let n=this.app_state.document;for(let a=0;a<i.length;a++)n=n.insert_item(i[a].clone());return this.new_document=n,t?r.push_all(i):r}do_extract_from_document(e,t){const s=this._get_prefix_argument(1,this.app_state.document.items.length);if(s<=0)return e;let r=this.app_state.document;if(r.selection_index<s)return this.error_flash_document();let i=[];for(let n=0;n<s;n++){const e=r.selected_item();r=r.delete_selection(),i.push(e.clone())}return i.reverse(),t||(this.new_document=r),e.push_all(i)}do_reset_all(e){return this.notify("Stack and document cleared"),this.new_document=new M([],0),new R([])}do_push_separator(e){return e.push(B.empty_item())}do_push(e,t){return t=t||"",e.push_expr(v.text_or_command(t))}do_self_push(e){return this.do_push(e,this.last_keypress)}do_push_placeholder(e){return e.push_expr(new z)}do_to_case(e,t){const[s,r]=e.pop_exprs(1);let i;return i="text"===r.expr_type()?new E((e=>{switch(t){case"uppercase":return e.toUpperCase();case"lowercase":return e.toLowerCase();default:return e}})(r.text)):r,s.push_expr(i)}do_operator(e,t){const s=parseInt(arguments.length>2&&void 0!==arguments[2]?arguments[2]:"1"),[r,...i]=e.pop_exprs(s),n=new k(t,i);return r.push_expr(n)}do_font_operator(e,t){const[s,r]=e.pop_exprs(1);let i=null;return i="command"!==r.expr_type()||1!==r.operand_count()||"boldsymbol"!==r.command_name&&"pmb"!==r.command_name?"command"===r.expr_type()&&1===r.operand_count()&&r.command_name===t?r:new k(t,[r]):new k("pmb",[new k(t,[r.operand_exprs[0]])]),s.push_expr(i)}do_named_function(e,t,s){let[r,i]=e.pop_exprs(1);const n=t;if(void 0!==s){let e="^";s.startsWith("_")&&(e="_",s=s.slice(1)),s.length>1&&(s=["{",s,"}"].join("")),t=[t,e,s].join("")}let a;return i=q.autoparenthesize(i),a="sech"===n||"csch"===n?new k("operatorname",[new E(t),i]):new k(t,[i]),r.push_expr(a)}do_underset_operator(e,t,s){const[r,i,n]=e.pop_exprs(2);let a;a=s?new k("operatorname",[new E(t)]):new k(t);const o=new A(new k("limits"),n),p=v.combine_pair(v.combine_pair(a,o),i);return r.push_expr(p)}do_apply_hat(e,t){let[s,r]=e.pop_exprs(1);if("text"!==r.expr_type()||"i"!==r.text&&"j"!==r.text){if("command"===r.expr_type()&&1===r.operand_count()&&("boldsymbol"===r.command_name||"mathbf"===r.command_name)){const e=r.operand_exprs[0];"text"!==e.expr_type()||"i"!==e.text&&"j"!==e.text||(r=new k(r.command_name,[new k("i"===e.text?"imath":"jmath")]))}}else r=new k("i"===r.text?"imath":"jmath");const i=new k(t,[r]);return s.push_expr(i)}do_html_class(e,t,s){let[r,i]=e.pop_exprs(1),n=null;return"command"===i.expr_type()&&"htmlClass"===i.command_name&&2===i.operand_count()&&"text"===i.operand_exprs[0].expr_type()?(i.operand_exprs[0].text===t&&(n=s),i=i.operand_exprs[1]):n=t,n&&(i=new k("htmlClass",[new E(n),i])),r.push_expr(i)}do_make_bold(e){const[t,s]=e.pop(1);return t.push(s.as_bold())}do_make_roman(e){const[t,s]=e.pop_exprs(1);let r=null;return r="command"===s.expr_type()&&"boldsymbol"===s.command_name&&1===s.operand_count()?new k("bold",s.operand_exprs):"command"===s.expr_type()&&"mathrm"===s.command_name?s:new k("mathrm",[s]),t.push_expr(r)}do_custom_delimiter(e,t){return this.switch_to_mode("custom_delimiters"),t?this.custom_delimiters.left?this.custom_delimiters.right?(this.custom_delimiters.middle=t,this._finish_custom_delimiters(e)):(this.custom_delimiters.right=t,null===this.prefix_argument||this.prefix_argument<=1?this._finish_custom_delimiters(e):void(this.preserve_prefix_argument=!0)):(this.custom_delimiters.left=t,void(this.preserve_prefix_argument=!0)):(this.custom_delimiters={},void(this.preserve_prefix_argument=!0))}_finish_custom_delimiters(e){this.switch_to_mode("base");const t=this.custom_delimiters;let s=this.prefix_argument||1;s<1&&(s=1);const[r,...i]=e.pop_exprs(s),n=new q(t.left,t.right,t.middle,i);return this.custom_delimiters={},r.push_expr(n)}do_toggle_fixed_size_delimiters(e){const[t,s]=e.pop_exprs(1);if("delimiter"===s.expr_type())return t.push_expr(s.as_fixed_size(!s.fixed_size));e.type_error()}do_remove_delimiters(e){const[t,s]=e.pop_exprs(1);return"delimiter"===s.expr_type()?t.push_expr(s.without_delimiters()):e}do_infix(e,t){const[s,r,i]=e.pop(2),n=r.item_type(),a=i.item_type();if("expr"===n&&"expr"===a){let e=v.text_or_command(t);const n=j.combine_infix(r.expr,i.expr,e);return s.push_expr(n)}if("expr"!==n&&"text"!==n||"expr"!==a&&"text"!==a)return e.type_error();{const e=B.concatenate_items(r,i,t);return s.push(e)}}do_conjunction(e,t){const[s,r,i]=e.pop(2),n=r.item_type(),a=i.item_type();if("expr"===n&&"expr"===a){const e=new C([new k("quad"),new k("text",[new E(t.replaceAll("_"," "))]),new k("quad")]);return s.push_expr(j.combine_infix(r.expr,i.expr,e))}if("expr"!==n&&"text"!==n||"expr"!==a&&"text"!==a)return e.type_error();{const e=B.from_string(" "+t+" "),n=B.concatenate_items(r,B.concatenate_items(e,i));return s.push(n)}}do_split_infix(e){const[t,s]=e.pop_exprs(1);if("infix"!==s.expr_type())return void this.error_flash_stack();const r=s.split_type;let i=null;i="after"===r?"before":"before"===r?null:"after";const n=s.with_split_at(s.split_at_index,i);return t.push_expr(n)}do_swap_infix(e){const[t,s]=e.pop_exprs(1);let r=null;return"infix"===s.expr_type()?r=s.swap_sides_at(s.split_at_index):"delimiter"===s.expr_type()&&2===s.inner_exprs.length&&(r=new q(s.left_type,s.right_type,s.middle_type,[s.inner_exprs[1],s.inner_exprs[0]],s.fixed_size)),r?t.push_expr(r):this.error_flash_stack()}do_cancel(){}do_concat(e){let[t,s,r]=e.pop(2);const i=s.item_type(),n=r.item_type();if("expr"===i&&"expr"===n){let e=s.expr,i=r.expr;const n=v.combine_pair(e,i);return t.push_expr(n)}if("expr"!==i&&"text"!==i||"expr"!==n&&"text"!==n)return e.type_error();{const e=B.concatenate_items(s,r);return t.push(e)}}do_fuse(e){const[t,s,r]=e.pop_exprs(2),i=new C([s,r],!0);return t.push_expr(i)}do_substitute_placeholder(e){const[t,s]=e.pop_exprs(1),[r,i]=t.pop(1);if("expr"===i.item_type()){const e=i.expr,t=e.find_placeholder();if(t){const i=e.substitute_expr(t,s);return r.push_expr(i)}}else if("text"===i.item_type()){const e=i.try_substitute_placeholder(s);if(e)return r.push(e)}return e.type_error()}do_extract_infix_side(e,t){const[s,r]=e.pop_exprs(1);let i=null;if("infix"===r.expr_type())i=r.extract_side_at(r.split_at_index,t);else{if("delimiter"!==r.expr_type()||2!==r.inner_exprs.length)return e.type_error();i="right"===t?r.inner_exprs[1]:r.inner_exprs[0]}return s.push_expr(i)}do_start_text_entry(e,t,s){return this.text_entry=new O(t,s),this.switch_to_mode(t),this.perform_undo_or_redo="suppress",e}do_cancel_text_entry(e){return this.perform_undo_or_redo="suppress",this.cancel_text_entry(e)}cancel_text_entry(e){const t=this.text_entry.edited_item;return this.text_entry=null,t?e.push(t):e}do_text_entry_move_cursor(e,t){return this.perform_undo_or_redo="suppress",this.switch_to_mode(this.mode),"left"===t?this.text_entry.left():"right"===t&&this.text_entry.right(),e}do_append_text_entry(e){const t=this.last_keypress;if(this.perform_undo_or_redo="suppress",this.switch_to_mode(this.mode),1===t.length){if("latex_entry"===this.text_entry.mode&&!/^[a-zA-Z]$/.test(t))return this.error_flash_stack();this.text_entry.insert(t)}return e}do_backspace_text_entry(e,t){return this.text_entry.is_empty()?(this.cancel_text_entry(e),t&&(this.text_entry=new O(t,""),this.switch_to_mode(t)),e):(this.text_entry.backspace(),this.switch_to_mode(this.mode),this.perform_undo_or_redo="suppress",e)}do_finish_text_entry(e,t){if(!this.text_entry)return e;if(this.text_entry.is_empty())return this.cancel_text_entry(e);if("text"===t||"heading"===t){let s=B.parse_string(this.text_entry.current_text);return"heading"===t&&(s.is_heading=!0),this.cancel_text_entry(e),e.push(s)}let s;return s="roman_math"===t?new k("mathrm",[new E(this._latex_escape(this.text_entry.current_text))]):"latex"===t?new k(this.text_entry.current_text):new E(this._latex_escape(this.text_entry.current_text)),this.cancel_text_entry(e),e.push_expr(s)}do_edit_item(e){const[t,s]=e.pop(1);if("text"===s.item_type()){const e=s.as_editable_string();if(e)return this.do_start_text_entry(t,"text_entry",e),this.text_entry.edited_item=s,t}else if("expr"===s.item_type()){let e=s.expr;if("command"===e.expr_type()&&0===e.operand_count())return this.do_start_text_entry(t,"latex_entry",e.command_name),this.text_entry.edited_item=s,t;if("command"===e.expr_type()&&1===e.operand_count()&&"mathrm"===e.command_name&&(e=e.operand_exprs[0]),"text"===e.expr_type()&&!e.text.startsWith("\\"))return this.do_start_text_entry(t,"math_text_entry",this._latex_unescape(e.text)),this.text_entry.edited_item=s,t}return this.error_flash_stack()}do_start_dissect_mode(e){const[t,s]=e.pop_exprs(1);return s.has_subexpressions()?(this.switch_to_mode("dissect"),this.perform_undo_or_redo="suppress",this.dissect_undo_stack=new f(s),t.push(new L(s,null,new b(s,[0])))):this.error_flash_stack()}do_cancel_dissect_mode(e){const[t,s]=e.pop_exprs(1);this.perform_undo_or_redo="suppress";const r=this.dissect_undo_stack.initial_expr;return this.dissect_undo_stack=null,t.push(new L(r,null,null))}do_dissect_undo(e){this.perform_undo_or_redo="suppress";const t=this.dissect_undo_stack.pop();if(t){const[s,r]=e.pop_exprs(1);return this.switch_to_mode("dissect"),s.push(new L(t.expr,null,t))}return this.do_cancel_dissect_mode(e)}do_dissect_descend(e){return this._do_dissect_operation(e,(e=>e.selected_expr().has_subexpressions()?e.descend(0):e))}do_dissect_ascend(e){return this._do_dissect_operation(e,(e=>e.depth()<=1?e:e.ascend()))}do_dissect_move_selection(e,t){return this._do_dissect_operation(e,(e=>e.move(t)))}do_dissect_extract_selection(e,t){const[s,r]=e.pop(1);"expr"!==r.item_type()&&e.type_error();const i=r.selected_expr_path,n=i.extract_selection(),a=i.selected_expr();return this.dissect_undo_stack=null,"trim"===t?s.push_expr(n):s.push_all_exprs([n,a])}do_dissect_copy_selection(e,t){const[s,r]=e.pop(1);"expr"!==r.item_type()&&e.type_error();const i=r.selected_expr_path,n=i.selected_expr();return this.dissect_undo_stack=null,"trim"===t?s.push_expr(n):s.push_all_exprs([i.expr,n])}_do_dissect_operation(e,t){const[s,r]=e.pop(1);"expr"!==r.item_type()&&e.type_error(),this.switch_to_mode(this.mode);const i=r.selected_expr_path,n=t(i);if(n){this.perform_undo_or_redo="suppress",this.dissect_undo_stack.push(i);const e=new L(n.expr,null,n);return s.push(e)}return this.error_flash_stack()}_latex_escape(e){const t={" ":"\\,",_:"\\_","^":"\\wedge ","%":"\\%","'":"\\rq ","`":"\\lq ",$:"\\$","&":"\\&","#":"\\#","}":"\\}","{":"\\{","~":"\\sim ","\\":"\\backslash "};return e.replaceAll(/[ _^%'`$&#}{~\\]/g,(e=>t[e]))}_latex_unescape(e){const t={"\\,":" ","\\_":"_","\\wedge ":"^","\\%":"%","\\rq ":"'","\\lq ":"`","\\$":"$","\\&":"&","\\#":"#","\\}":"}","\\{":"{","\\sim ":"~","\\backslash ":"\\"};return e.replaceAll(/\\,|\\_|\\wedge |\\%|\\rq |\\lq |\\\$|\\&|\\#|\\\}|\\\{|\\sim |\\backslash /g,(e=>t[e]))}do_toggle_is_heading(e){let[t,s]=e.pop(1);if("expr"===s.item_type()&&(s=B.from_expr(s.expr)),"text"===s.item_type())return s.is_empty()?this.error_flash_stack():(s=s.clone(),s.is_heading=!s.is_heading,t.push(s));this.error_flash_stack()}do_extract_latex_source(e){const[t,s]=e.pop_exprs(1),r=s.to_text(),i=new P("latex",r);return e.push(i)}do_delimiters(e,t,s,r,i){const n=void 0===i?1:parseInt(i),[a,...o]=e.pop_exprs(n);let p=null;return p=1===n&&"delimiter"===o[0].expr_type()&&"."===o[0].left_type&&"."===o[0].right_type?new q(t,s,o[0].middle_type,o[0].inner_exprs):new q(t,s,r,o),a.push_expr(p)}do_parenthesize(e){let[t,s]=e.pop_exprs(1);return"delimiter"===s.expr_type()&&"."===s.left_type&&"."===s.right_type&&s.inner_exprs.length>1?s=new q("(",")",s.middle_type,s.inner_exprs):"delimiter"!==s.expr_type()&&(s=q.parenthesize(s)),t.push_expr(s)}do_autoparenthesize(e,t){const s=void 0===t?1:parseInt(t),[r,...i]=e.pop(s);return i.every((e=>"expr"===e.item_type()))?r.push_all_exprs(i.map((e=>q.autoparenthesize(e.expr)))):e}do_apply_operator(e,t){const s=parseInt(t),[r,i,...n]=e.pop_exprs(s+1);if("command"===i.expr_type()&&0===i.operand_count())return r.push_expr(new k(i.command_name,n));this.error_flash_stack()}do_apply_infix(e){let[t,s,r,i]=e.pop_exprs(3);"command"===i.expr_type()&&"mathrm"===i.command_name&&1===i.operand_count()&&(i=new C([new k("quad"),i,new k("quad")]));const n=j.combine_infix(s,r,i);return t.push_expr(n)}do_toggle_popup(e,t){if("help"===this.settings.popup_mode){const e=document.getElementById("popup_panel");e&&e.scrollTop&&(this.settings.help_scroll_top=e.scrollTop)}this.settings.popup_mode=this.settings.popup_mode===t?null:t,this.settings.save(),this.app_component.apply_layout_to_dom()}do_config(e,t,s){let r,i=this.settings,n=i.layout,a=!1;switch(t){case"zoom_factor":r=this._get_prefix_argument(1,-1),r<0?n.zoom_factor=0:"decrease"===s?n.zoom_factor-=r:n.zoom_factor+=r,this.notify("Zoom level: "+(n.zoom_factor>0?"+":"")+n.zoom_factor);break;case"math_align":"toggle_document"===s?n.document_rightalign_math=!n.document_rightalign_math:"toggle_stack"===s&&(n.stack_rightalign_math=!n.stack_rightalign_math);break;case"toggle_inline_math":n.inline_math=!n.inline_math,a=!0;break;case"toggle_mode_indicator":i.show_mode_indicator=!i.show_mode_indicator,this.notify("Mode indicator "+(i.show_mode_indicator?"enabled":"disabled"));break;case"stack_side":n.stack_side=s;break;case"stack_split":r=this._get_prefix_argument(5,10),r<=10&&(r*=10),r>100&&(r=100),n.stack_split=r;break;case"inverse_video":i.inverse_video=!i.inverse_video;break;case"reset_layout":i.layout=i.default_layout(),i.inverse_video=!1,i.show_mode_indicator=!0,a=!0;break;case"reload_page":window.location.reload()}if(i.save(),this.perform_undo_or_redo="suppress",this.app_component.apply_layout_to_dom(),this.clear_all_flashes(),a)return this.new_document=this.app_state.document.clone_all_items(),e.clone_all_items()}do_fullscreen(e,t){return"off"===t?document.exitFullscreen():document.getElementsByTagName("html")[0].requestFullscreen(),this.perform_undo_or_redo="suppress",e}do_build_matrix_row(e,t,s){const r=s?parseInt(s):this._get_prefix_argument(0,e.depth());if(r<=0)return this.error_flash_stack();const[i,...n]=e.pop_exprs(r),a=new S(t||"bmatrix",1,r,[n]);return i.push_expr(a)}do_stack_arrays(e){const[t,s,r]=e.pop_arrays(2),i=S.stack_arrays(s,r);return i?t.push_expr(i):t.type_error()}do_split_array(e){const[t,s]=e.pop_arrays(1);return t.push_all_exprs(s.split_rows())}do_dissolve_array(e){const[t,s]=e.pop_arrays(1);let r=[].concat(...s.element_exprs);return t.push_all_exprs(r)}do_insert_matrix_ellipses(e){const[t,s]=e.pop_matrices(1);return t.push_expr(s.with_ellipses())}do_transpose_matrix(e){const[t,s]=e.pop_matrices(1);return t.push_expr(s.transposed())}do_change_matrix_type(e,t){const[s,r]=e.pop_matrices(1);return s.push_expr(r.with_array_type(t))}do_array_separator(e,t,s){const[r,i]=e.pop_matrices(1),n="column"===t,a=n?i.column_count:i.row_count,o=this._get_prefix_argument(1,null);return null!==o&&(o<1||o>a-1)?this.error_flash_stack():r.push_expr(i.with_separator(n,null===o?null:o-1,s,!0))}do_build_align(e,t){const s=this._get_prefix_argument(0,e.depth());if(s<=0)return this.error_flash_stack();const[r,...i]=e.pop_exprs(s);let n;switch(t){case"gathered":case"gather":n="none";break;case"cases":case"rcases":n="colon";break;case"cases_if":n="colon_if",t="cases";break;case"rcases_if":n="colon_if",t="rcases";break;default:n="infix"}const a=S.split_elements(i,n),o=new S(t,a.length,a[0].length,a);return r.push_expr(o)}do_build_infix_list(e,t,s){this._require_prefix_argument(!0);const r=this._get_prefix_argument(1,e.depth()),[i,...n]=e.pop_exprs(r),a=v.text_or_command(t);let o=n;if(s){const e=v.text_or_command(s);o=o.slice(0,r-1).concat([e]).concat(o.slice(r-1))}let p=o[0];for(let _=1;_<o.length;_++)p=j.combine_infix(p,o[_],a);return i.push_expr(p)}do_build_substack(e){const t=this._require_prefix_argument(),[s,...r]=e.pop_exprs(t),i=r.map((e=>[e]));return s.push_expr(new S("substack",t,1,i))}do_apply_tag(e){let t,[s,r,i]=e.pop(2);return"expr"!==r.item_type()||"expr"!==i.item_type()?e.type_error():(t=i.expr,s.push(new L(r.expr,t)))}do_copy_to_clipboard(e){const[t,s]=e.pop(1),r=this._get_prefix_argument(1,"*");return this.app_component.state.clipboard_items[r]=s,1===r?this.notify("Copied to clipboard"):this.notify("Copied to clipboard slot "+r),this.perform_undo_or_redo="suppress",t.push(s)}do_paste_from_clipboard(e){const t=this._get_prefix_argument(1,"*"),s=this.app_component.state.clipboard_items[t];if(s)return e.push(s.clone());this.error_flash_stack()}do_recenter_document(e,t){const s=parseInt(t);this.perform_undo_or_redo="suppress";let r=document.getElementById("document_container");if(!r)return;const i=r.getElementsByClassName("selected");if(0===i.length)return;const n=i[0],a=n.offsetTop,o=n.offsetTop+n.offsetHeight-r.clientHeight,p=s/100,_=Math.round(a*(1-p)+o*p);r.scrollTop=_}do_scroll(e,t,s,r){let i=document.getElementById(t);if(!i)return;const n=parseInt(r||"50")/100;"horizontal"===s?i.scrollLeft+=Math.round(i.clientWidth*n):i.scrollTop+=Math.round(i.clientHeight*n)}do_export_document_as_text(e){const t=this.app_state.document.to_text();navigator.clipboard.writeText(t),this.notify("Copied document to clipboard"),this.perform_undo_or_redo="suppress"}do_export_stack_items_as_text(e){const t=this._get_prefix_argument(1,e.depth()),[s,...r]=e.pop(t),i=r.map((e=>e.to_text())).join("\n\n");navigator.clipboard.writeText(i),this.notify("Copied "+t+" item"+(1===t?"":"s")+" to clipboard"),this.perform_undo_or_redo="suppress"}};const $=i.a.createElement;class W extends i.a.Component{constructor(e){super(e);let t=u.load_from_local_storage();this.state={app_state:new m,settings:t,file_manager_state:new y,import_export_state:new w,document_storage:new g,input_context:new V(this,t),undo_stack:new x,clipboard_items:{}},this.state.undo_stack.clear(this.state.app_state),this.state.import_export_state.document_storage=this.state.document_storage,this.state.import_export_state.onstatechange=()=>this.import_export_state_changed(),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleBeforeUnload=this.handleBeforeUnload.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.state.document_storage.open_database(this.on_open_database.bind(this))}on_open_database(){if(this.request_file_list(),this.state.settings.last_opened_filename)this.start_loading_filename(this.state.settings.last_opened_filename);else{let e=this.state.file_manager_state,t=this.state.settings;const s="untitled";e.current_filename=e.selected_filename=s,t.last_opened_filename=s,t.save()}}file_manager_state_changed(){this.setState({file_manager_state:this.state.file_manager_state})}import_export_state_changed(){const e=this.state.import_export_state;this.setState({import_export_state:e}),e.file_list_needs_update&&(e.file_list_needs_update=!1,this.request_file_list())}request_file_list(){this.state.document_storage.fetch_file_list(this.file_list_request_finished.bind(this),this.file_list_request_error.bind(this))}file_list_request_finished(e){let t=this.state.file_manager_state;t.unavailable=!1,t.file_list=e,t.sort_file_list("filename",!0),this.setState({file_manager_state:t})}file_list_request_error(){let e=this.state.file_manager_state;e.unavailable=!0,this.setState({file_manager_state:e})}start_loading_filename(e){this.state.document_storage.load_state(e,this.file_load_finished.bind(this),this.file_load_error.bind(this))}file_load_finished(e,t){const s=this.state.file_manager_state,r=this.state.settings;s.selected_filename=s.current_filename=e,r.last_opened_filename=e,r.save(),this.setState({app_state:t,file_manager_state:s}),this.state.undo_stack.clear(t),this.state.input_context.notify("Loaded: "+e)}file_load_error(e,t){}componentDidMount(){this.apply_layout_to_dom(),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("beforeunload",this.handleBeforeUnload),window.addEventListener("visibilitychange",this.handleVisibilityChange),this.request_file_list()}apply_layout_to_dom(){let e=document.getElementById("body");this.state.settings.inverse_video?e.classList.add("inverse_video"):e.classList.remove("inverse_video"),this.stack_panel_ref.current&&this.document_panel_ref.current&&this.popup_panel_ref.current&&this.state.settings.apply_layout_to_dom(this.stack_panel_ref.current,this.document_panel_ref.current,this.popup_panel_ref.current)}componentDidUpdate(){const e="["+(this.state.file_manager_state.current_filename||"rpnlatex")+"]";e!==document.title&&(document.title=e)}componentWillUnmount(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("beforeunload",this.handleBeforeUnload),window.removeEventListener("visibilitychange",this.handleVisibilityChange)}render(){const e=this.state.app_state,t=this.state.settings,s=this.state.input_context;this.stack_panel_ref=i.a.createRef(),this.document_panel_ref=i.a.createRef(),this.popup_panel_ref=i.a.createRef();let r=[$(X,{settings:t,stack:e.stack,input_context:s})];return(t.show_mode_indicator||s.notification_text)&&r.push($(F,{app_state:e,input_context:s})),$("div",{id:"panel_layout"},$("div",{className:"panel stack_panel",id:"stack_panel",ref:this.stack_panel_ref},...r),$("div",{className:"panel document_panel",id:"document_panel",ref:this.document_panel_ref},$("div",{id:"document_container"},$(G,{settings:t,document:e.document,filename:this.state.file_manager_state.current_filename,is_dirty:e.is_dirty}))),$(Z,{settings:t,popup_panel_ref:this.popup_panel_ref,import_export_state:this.state.import_export_state,document_storage:this.state.document_storage,file_manager_state:this.state.file_manager_state}))}handleKeyDown(e){if(e.altKey||e.metaKey)return;const t=this._keyname_from_event(e);if("Meta"===t||"Ctrl+Control"===t)return;let s=this.state.app_state,[r,i]=this.state.input_context.handle_key(s,t);if(r){e.preventDefault();const t=this.manage_undo_state(i);t?i=t:this.state.input_context.error_flash_stack();let s={app_state:i};this.state.input_context.files_changed&&(this.request_file_list(),s.file_manager_state=this.state.file_manager_state),this.setState(s)}}_keyname_from_event(e){let t=e.key;return(t.startsWith("Arrow")||"Enter"===t||"Backspace"===t)&&e.shiftKey&&(t="Shift+"+t),e.ctrlKey&&(t="Ctrl+"+t),t}handleBeforeUnload(e){const t=this.state.file_manager_state.current_filename;return t&&this.state.document_storage.save_state(this.state.app_state,t),null}handleVisibilityChange(e){this.setState({})}manage_undo_state(e){let t=this.state.undo_stack;switch(this.state.input_context.perform_undo_or_redo){case"undo":return t.undo_state();case"redo":return t.redo_state();case"suppress":return e;case"clear":return t.clear(e),e;default:return t.push_state(e),e}}}class F extends i.a.Component{render(){const e=this.props.input_context;let t;const s=e.notification_text;let r=e.mode;if(null!==e.prefix_argument&&(r=[r,"(",e.prefix_argument<0?"*":e.prefix_argument.toString(),")"].join("")),s){const e=s.indexOf(":");t=e>=0?$("span",{className:"notification"},$("span",{},s.slice(0,e+1)),$("span",{className:"highlighted"},s.slice(e+1))):$("span",{className:"notification"},s)}else"base"!==r&&(t=$("span",{className:"mode"},r.replaceAll("_"," ")));return $("div",{className:"indicator"},t)}}class X extends i.a.Component{render(){let e=this.props.input_context;const t=this.props.stack.items.map(((t,s)=>{const r="stack"===e.mode&&(e.prefix_argument<0||this.props.stack.items.length-s<=e.prefix_argument);return $(J,{item:t,selected:r,inline_math:this.props.settings.layout.inline_math,item_ref:i.a.createRef(),key:t.react_key(s)})}));if(e.text_entry){const s=$(H,{text:e.text_entry.current_text,cursor_position:e.text_entry.cursor_position,entry_type:e.text_entry.mode,key:"textentry"});t.push(s)}let s=["stack_items"];return this.props.settings.layout.stack_rightalign_math&&s.push("rightalign_math"),$("div",{className:s.join(" ")},t)}}class G extends i.a.Component{render(){const e=this.props.document,t=e.items.map(((t,s)=>{let r=i.a.createRef();const n=e.selection_index===s+1;return n&&(this.selected_item_ref=r),$(J,{item:t,selected:n,inline_math:this.props.settings.layout.inline_math,item_ref:r,key:t.react_key(s)})}));t.push($("div",{className:"bottom_spacer",key:"bottom_spacer"}));const s=0===e.selection_index;s&&(this.selected_item_ref=i.a.createRef());const r=$("div",{className:"top_spacer"+(s?" selected":""),key:"top_spacer",ref:s?this.selected_item_ref:null});let n=["document_items"];return this.props.settings.layout.document_rightalign_math&&n.push("rightalign_math"),$("div",{className:n.join(" ")},[r].concat(t))}componentDidUpdate(){this.ensure_selection_visible()}ensure_selection_visible(){if(!this.selected_item_ref)return;const e=this.selected_item_ref.current;if(!e)return;let t=document.getElementById("document_container");const s=e.offsetHeight/2;e.offsetTop<t.scrollTop&&(t.scrollTop=e.offsetTop-s),e.offsetTop+e.offsetHeight>t.scrollTop+t.offsetHeight&&(t.scrollTop=e.offsetTop+e.offsetHeight-t.offsetHeight+s)}}class H extends i.a.Component{render(){const e="text_entry "+this.props.entry_type+"_mode",t=this.props.cursor_position;let s=this.props.text;return this.props.cursor_position===s.length&&(s+=" "),$("div",{className:e},$("span",{className:"normal_characters"},s.slice(0,t)),$("span",{className:"cursored_character"},s.slice(t,t+1)),$("span",{className:"normal_characters"},s.slice(t+1)))}}class K extends i.a.Component{render(){const e=!this.props.file_manager_state.unavailable;return this.file_input_ref=i.a.createRef(),$("div",{className:"file_header",id:"files_panel"},$("h2",{},"File Manager"),this.render_current_filename(),this.render_file_table(),this.render_shortcuts(),e&&$("h2",{},"Export/Import"),e&&this.render_export_import_section())}render_export_import_section(){const e=this.props.import_export_state;let t=[];if(t.push($("p",{},"This section lets you download the internal browser document storage as a .zip file, or restore the internal storage from a previously downloaded export.")),t.push($("p",{},$("strong",{},e.textual_state()))),"idle"===e.state&&t.push($("p",{},$("a",{href:"#",onClick:this.start_exporting.bind(this)},"Prepare Export"))),e.download_available()){const s=e.generate_download_filename();t.push($("p",{},$("a",{href:e.download_url,download:s},"Download: "+s)))}return"idle"===e.state&&t.push($("p",{},$("span",{},"Import Zip File: "),$("input",{type:"file",ref:this.file_input_ref}),$("input",{type:"button",value:"Upload",onClick:this.handle_file_upload.bind(this)}))),"idle"===e.state&&e.import_result_string&&t.push($("p",{},$("span",{style:{fontWeight:"bold"}},"Import result: "),$("span",{},e.import_result_string))),$("div",{},...t)}render_current_filename(){const e=this.props.file_manager_state.current_filename;return e?$("div",{className:"current_file"},$("label",{},"Current file:"),$("span",{className:"filename"},e)):null}render_file_table(){const e=this.props.file_manager_state;return e.unavailable?$("p",{},"IndexedDB support unavailable in your browser.  You will be unable to save or load documents.  Note that Firefox disables IndexedDB when in Private Browsing mode."):e.file_list&&e.file_list.length>0?$("div",{},$("table",{className:"file_table"},$("thead",{},$("tr",{},$("th",{className:"filename"},"Filename"),$("th",{className:"filesize",colSpan:"2"},"Size"),$("th",{className:"timestamp",colSpan:"2"},"Last Modified"))),$("tbody",{},e.file_list.map(((e,t)=>this._render_file_list_row(e,t)))))):e.file_list?$("p",{},"No files created yet."):$("p",{},"Fetching file list...")}_render_file_list_row(e,t){const s=this.props.file_manager_state;let r=[];e.filename===s.selected_filename&&r.push("selected_file"),e.filename===s.current_filename&&r.push("current_file");const i=e.document_item_count+e.stack_item_count;return $("tr",{className:r.join(" "),key:"file_"+e.filename},$("td",{className:"filename"},e.filename),$("td",{className:"filesize"},Math.floor((e.filesize+1023)/1024)+" kb"),$("td",{className:"filesize"},i+" object"+(1===i?"":"s")),$("td",{className:"timestamp"},e.timestamp.toLocaleDateString()),$("td",{className:"timestamp"},e.timestamp.toLocaleTimeString()))}render_shortcuts(){const e=[["Escape","Close file manager"],["Arrows","Select next/previous file"],["Enter","Open selected file"],["d","Delete selected file"],["n","Start a new empty file"],["s","Save current file"],["S","Save as..."]].map((e=>{const[t,s]=e;return $("li",{},$("span",{className:"keybinding"},t),$("span",{}," "+s))}));return $("ul",{className:"keybindings"},...e)}handle_file_upload(e){const t=this.file_input_ref.current;if(!t)return;const s=t.files;1===s.length?this.start_importing(s[0]):s.length>1?alert("Please select a single .zip file to import."):alert("Please select a .zip file to import.")}start_importing(e){const t=this.props.import_export_state;"idle"===t.state&&t.start_importing(e)}start_exporting(){const e=this.props.import_export_state;"idle"===e.state&&e.start_exporting()}}class J extends i.a.Component{render(){let e=this.props.item,t=this.props.item_ref,s=this.props.selected?"selected ":"";switch("text"===e.item_type()&&e.is_heading&&(s="heading_style "+s),e.item_type()){case"expr":return e.tag_expr?(this.tag_ref=i.a.createRef(),$("div",{className:"expr_item"},$("div",{className:"tag_expr",ref:this.tag_ref},""),$("div",{className:s+"latex_fragment",ref:t},""))):$("div",{className:"expr_item"},$("div",{className:s+"latex_fragment",ref:t},""));case"text":return e.is_empty()?$("div",{className:s+"separator_item"},$("hr")):$("div",{className:"text_item"},$("div",{className:s+"latex_fragment"},$("div",{className:"latex_fragment_inner",ref:t},"")));case"code":return $("div",{className:"latex_source_item"},$("div",{className:"latex_source"},e.source));default:return $("div",{},"????")}}componentDidMount(){const e=this.props.item,t=this.props.item_ref.current;t&&("expr"===e.item_type()?(this._render_with_katex(e.to_latex(),t,!this.props.inline_math),e.tag_expr&&this.tag_ref.current&&this._render_with_katex(e.tag_expr.to_latex(),this.tag_ref.current,!1)):"text"===e.item_type()&&this._render_with_katex(e.to_latex(),t,!1))}_render_with_katex(e,t,s){""!==e&&"\\,"!==e||(e="\\text{(blank)}");try{p.a.render(e,t,{throwOnError:!1,displayMode:s,fleqn:!0,trust:!0,strict:!1,minRuleThickness:.06})}catch(r){const e=r.toString();t.innerHTML='<div style="color:red;">'+e+"</div>"}}}class Z extends i.a.Component{render(){this.refs={help:i.a.createRef(),help_content:i.a.createRef()};let e=null;return"files"===this.props.settings.popup_mode&&(e=$("div",{id:"files_container"},$(K,{import_export_state:this.props.import_export_state,document_storage:this.props.document_storage,file_manager_state:this.props.file_manager_state}))),$("div",{id:"popup_panel",ref:this.props.popup_panel_ref},e,$("div",{id:"help_container",ref:this.refs.help},$("div",{className:"help",ref:this.refs.help_content})))}componentDidMount(){const e=document.getElementById("helptext"),t=this.refs.help_content.current;e&&(e.style.display="block",this._render_help_latex(e),e.parentNode.removeChild(e),t.appendChild(e))}componentDidUpdate(){const e=this.props.settings.popup_mode;this.refs.help.current&&(this.refs.help.current.style.display="help"===e?"block":"none"),"help"===e&&void 0!==this.props.settings.help_scroll_top&&this.props.popup_panel_ref.current&&(this.props.popup_panel_ref.current.scrollTop=this.props.settings.help_scroll_top,this.props.settings.help_scroll_top=void 0)}_render_help_latex(e){const t=e.getElementsByTagName("code");for(let s=0;s<t.length;s++){let e=t[s];const r=e.textContent;r&&p.a.render(r,e,{throwOnError:!1,displayMode:!1,trust:!0,strict:!1})}}}var Q=W;const Y=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function ee(e,t){navigator.serviceWorker.register(e).then((e=>{e.onupdatefound=()=>{const s=e.installing;null!=s&&(s.onstatechange=()=>{"installed"===s.state&&(navigator.serviceWorker.controller?(console.log("New content is available and will be used when all tabs for this page are closed. See https://cra.link/PWA."),t&&t.onUpdate&&t.onUpdate(e)):(console.log("Content is cached for offline use."),t&&t.onSuccess&&t.onSuccess(e)))})}})).catch((e=>{console.error("Error during service worker registration:",e)}))}var te=s(7);a.a.createRoot(document.getElementById("root")).render(Object(te.jsx)(Q,{})),function(e){if("serviceWorker"in navigator){if(new URL(".",window.location.href).origin!==window.location.origin)return;window.addEventListener("load",(()=>{const t="".concat(".","/service-worker.js");Y?(!function(e,t){fetch(e,{headers:{"Service-Worker":"script"}}).then((s=>{const r=s.headers.get("content-type");404===s.status||null!=r&&-1===r.indexOf("javascript")?navigator.serviceWorker.ready.then((e=>{e.unregister().then((()=>{window.location.reload()}))})):ee(e,t)})).catch((()=>{console.log("No internet connection found. App is running in offline mode.")}))}(t,e),navigator.serviceWorker.ready.then((()=>{console.log("This web app is being served cache-first by a service worker. To learn more, visit https://cra.link/PWA")}))):ee(t,e)}))}}()}},[[22,1,2]]]);
//# sourceMappingURL=main.cb6e30fc.chunk.js.map